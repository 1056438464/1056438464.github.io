<!DOCTYPE html>
<html>
    <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">


<title>shang wj</title>


<link rel="stylesheet" href="/styles/main.css">


    <meta name="generator" content="Hexo 7.3.0"></head>
    <body>
        <div class="container">
            <header>
<div class="main">
<div class="title">
    <a href="#" class="logo">shang wj</a>
</div>
<div class="site-nav">
    <ul id="menu" class="menu">
    
        <li class="menu-item text-underline">
            <a href="/">Home</a>
        </li>
    
        <li class="menu-item text-underline">
            <a href="/archives">Archives</a>
        </li>
    
        <li class="menu-item text-underline">
            <a href="/about/">About</a>
        </li>
            
    </ul>
</div>
</div>
</header>
            <main class="main">
                <section class="posts clearfix">
    <div class="posts-wrapper">
    
        <article class="post article-entry">
            <div class="post-title">
                <a class="post-title-link text-underline" href="/2024/08/15/410/">SpringBoot实现 License 认证（只校验有效期）</a>
            </div>
            <p class="sub">Aug 15 2024</p>
            <div class="post-content">
                
                    <p>使用开源的证书管理引擎TrueLicense</p>
<ul>
<li>生成密钥对，使用Keytool生成公私钥证书库</li>
<li>授权者保留私钥，使用私钥和使用日期生成证书license</li>
<li>公钥与生成的证书给使用者（放在验证的代码中使用），验证证书license是否在有效期内</li>
</ul>
<h2 id="二、授权者生成密钥对"><a href="#二、授权者生成密钥对" class="headerlink" title="二、授权者生成密钥对"></a>二、授权者生成密钥对</h2><p>需要关注以及修改的参数：storepass(私钥库的密码)、keypass(私钥的密码)</p>
<p>其他参数使用默认值即可，validity(私钥的有效期)设置十年就可以，因为以后会通过私钥和证书有效期生成证书license</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">## <span class="number">1.</span> 生成私匙库</span><br><span class="line"># validity：私钥的有效期（单位：天）</span><br><span class="line"># alias：私钥别称</span><br><span class="line"># keystore: 私钥库文件名称(生成在当前目录)</span><br><span class="line"># storepass：私钥库的密码(获取keystore信息所需的密码) </span><br><span class="line"># keypass：私钥的密码</span><br><span class="line"># dname 证书个人信息</span><br><span class="line">#  CN 为你的姓名</span><br><span class="line"># OU 为你的组织单位名称</span><br><span class="line"># O 为你的组织名称</span><br><span class="line"># L 为你所在的城市名称</span><br><span class="line"># ST 为你所在的省份名称</span><br><span class="line"># C 为你的国家名称 或 区号</span><br><span class="line">keytool -genkeypair -keysize <span class="number">1024</span> -validity <span class="number">3650</span> -alias <span class="string">&quot;privateKey&quot;</span> -keystore <span class="string">&quot;privateKeys.keystore&quot;</span> -storepass <span class="string">&quot;public_password1234&quot;</span> -keypass <span class="string">&quot;private_password1234&quot;</span> -dname <span class="string">&quot;CN=localhost, OU=localhost, O=localhost, L=SH, ST=SH, C=CN&quot;</span></span><br><span class="line"></span><br><span class="line">## <span class="number">2.</span> 把私匙库内的公匙导出到一个文件当中</span><br><span class="line"># alias：私钥别称</span><br><span class="line"># keystore：私钥库的名称(在当前目录查找)</span><br><span class="line"># storepass: 私钥库的密码</span><br><span class="line"># file：证书名称</span><br><span class="line">keytool -exportcert -alias <span class="string">&quot;privateKey&quot;</span> -keystore <span class="string">&quot;privateKeys.keystore&quot;</span> -storepass <span class="string">&quot;public_password1234&quot;</span> -file <span class="string">&quot;certfile.cer&quot;</span></span><br><span class="line"></span><br><span class="line">## <span class="number">3.</span> 再把这个证书文件导入到公匙库</span><br><span class="line"># alias：公钥别称</span><br><span class="line"># file：证书名称</span><br><span class="line"># keystore：公钥文件名称(生成在当前目录)</span><br><span class="line"># storepass：私钥库的密码</span><br><span class="line">keytool -<span class="keyword">import</span> -alias <span class="string">&quot;publicCert&quot;</span> -file <span class="string">&quot;certfile.cer&quot;</span> -keystore <span class="string">&quot;publicCerts.keystore&quot;</span> -storepass <span class="string">&quot;public_password1234&quot;</span></span><br></pre></td></tr></table></figure>
<p>上述命令执行完成后会在当前目录生成三个文件：</p>
<ul>
<li>certfile.cer 认证证书文件，已经没用了，可以删除</li>
<li>privateKeys.keystore 私钥文件，自己保存，以后用于生成license.lic证书</li>
<li>publicKeys.keystore 公钥文件，以后会和license.lic证书一起放到使用者项目里</li>
</ul>
<h2 id="三、授权者生成license-lic证书"><a href="#三、授权者生成license-lic证书" class="headerlink" title="三、授权者生成license.lic证书"></a>三、授权者生成license.lic证书</h2><p>pom.xml</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- License --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>de.schlichtherle.truelicense<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>truelicense-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.33<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="1、License生成类"><a href="#1、License生成类" class="headerlink" title="1、License生成类"></a>1、License生成类</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> de.schlichtherle.license.*;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> javax.security.auth.x500.X500Principal;</span><br><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.time.LocalDateTime;</span><br><span class="line"><span class="keyword">import</span> java.time.ZoneId;</span><br><span class="line"><span class="keyword">import</span> java.util.Date;</span><br><span class="line"><span class="keyword">import</span> java.util.prefs.Preferences;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LicenseCreator</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="type">X500Principal</span> <span class="variable">DEFAULT_HOLDER_AND_ISSUER</span> <span class="operator">=</span> </span><br><span class="line">     <span class="keyword">new</span> <span class="title class_">X500Principal</span>(<span class="string">&quot;CN=localhost, OU=localhost, O=localhost, L=SH, ST=SH, C=CN&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@description</span> main方法生成license文件</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@author</span> xuchang</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@date</span> 2024/3/4 15:51:14</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">LicenseCreatorParam</span> <span class="variable">param</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">LicenseCreatorParam</span>();</span><br><span class="line">        <span class="comment">// 证书主题</span></span><br><span class="line">        param.setSubject(<span class="string">&quot;license&quot;</span>);</span><br><span class="line">        <span class="comment">// 密钥别称</span></span><br><span class="line">        param.setPrivateAlias(<span class="string">&quot;privateKey&quot;</span>);</span><br><span class="line">        <span class="comment">// 私钥密码</span></span><br><span class="line">        param.setKeyPass(<span class="string">&quot;private_password1234&quot;</span>);</span><br><span class="line">        <span class="comment">// 私钥库的密码</span></span><br><span class="line">        param.setStorePass(<span class="string">&quot;public_password1234&quot;</span>);</span><br><span class="line">        <span class="comment">// 证书生成路径</span></span><br><span class="line">        param.setLicensePath(<span class="string">&quot;/Users/xuchang/Documents/license/license.lic&quot;</span>);</span><br><span class="line">        <span class="comment">// 私钥存储路径</span></span><br><span class="line">        param.setPrivateKeysStorePath(<span class="string">&quot;/Users/xuchang/Documents/license/privateKeys.keystore&quot;</span>);</span><br><span class="line">        <span class="comment">// 证书生成时间-当前时间</span></span><br><span class="line">        param.setIssuedTime(<span class="keyword">new</span> <span class="title class_">Date</span>());</span><br><span class="line">        <span class="type">LocalDateTime</span> <span class="variable">localDateTime</span> <span class="operator">=</span> LocalDateTime.of(<span class="number">2024</span>, <span class="number">12</span>, <span class="number">31</span>, <span class="number">23</span>, <span class="number">59</span>, <span class="number">59</span>);</span><br><span class="line">        <span class="type">Date</span> <span class="variable">date</span> <span class="operator">=</span> Date.from(localDateTime.atZone(ZoneId.systemDefault()).toInstant());</span><br><span class="line">        <span class="comment">// 证书过期时间-2024年12月31日23:59:59</span></span><br><span class="line">        param.setExpiryTime(date);</span><br><span class="line">        <span class="comment">// 用户类型</span></span><br><span class="line">        param.setConsumerType(<span class="string">&quot;user&quot;</span>);</span><br><span class="line">        <span class="comment">// 用户数量</span></span><br><span class="line">        param.setConsumerAmount(<span class="number">1</span>);</span><br><span class="line">        <span class="comment">// 证书描述</span></span><br><span class="line">        param.setDescription(<span class="string">&quot;证书描述信息&quot;</span>);</span><br><span class="line">        <span class="comment">// 生成证书</span></span><br><span class="line">        <span class="type">LicenseCreator</span> <span class="variable">licenseCreator</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">LicenseCreator</span>();</span><br><span class="line">        licenseCreator.generateLicense(param);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 生成License证书</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">generateLicense</span><span class="params">(LicenseCreatorParam param)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">LicenseManager</span> <span class="variable">licenseManager</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">LicenseManager</span>(initLicenseParam(param));</span><br><span class="line">            <span class="type">LicenseContent</span> <span class="variable">licenseContent</span> <span class="operator">=</span> initLicenseContent(param);</span><br><span class="line">            licenseManager.store(licenseContent, <span class="keyword">new</span> <span class="title class_">File</span>(param.getLicensePath()));</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;证书生成失败&quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 初始化证书生成参数</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> LicenseParam <span class="title function_">initLicenseParam</span><span class="params">(LicenseCreatorParam param)</span> &#123;</span><br><span class="line">        <span class="type">Preferences</span> <span class="variable">preferences</span> <span class="operator">=</span> Preferences.userNodeForPackage(LicenseCreator.class);</span><br><span class="line">        <span class="comment">// 设置对证书内容加密的秘钥</span></span><br><span class="line">        <span class="type">CipherParam</span> <span class="variable">cipherParam</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultCipherParam</span>(param.getStorePass());</span><br><span class="line">        <span class="comment">// 自定义KeyStoreParam</span></span><br><span class="line">        <span class="type">KeyStoreParam</span> <span class="variable">privateStoreParam</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CustomKeyStoreParam</span>(LicenseCreator.class</span><br><span class="line">                , param.getPrivateKeysStorePath()</span><br><span class="line">                , param.getPrivateAlias()</span><br><span class="line">                , param.getStorePass()</span><br><span class="line">                , param.getKeyPass());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 组织License参数</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">DefaultLicenseParam</span>(param.getSubject()</span><br><span class="line">                , preferences</span><br><span class="line">                , privateStoreParam</span><br><span class="line">                , cipherParam);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 设置证书生成正文信息</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> LicenseContent <span class="title function_">initLicenseContent</span><span class="params">(LicenseCreatorParam param)</span> &#123;</span><br><span class="line">        <span class="type">LicenseContent</span> <span class="variable">licenseContent</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">LicenseContent</span>();</span><br><span class="line">        licenseContent.setHolder(DEFAULT_HOLDER_AND_ISSUER);</span><br><span class="line">        licenseContent.setIssuer(DEFAULT_HOLDER_AND_ISSUER);</span><br><span class="line">        licenseContent.setSubject(param.getSubject());</span><br><span class="line">        licenseContent.setIssued(param.getIssuedTime());</span><br><span class="line">        licenseContent.setNotBefore(param.getIssuedTime());</span><br><span class="line">        licenseContent.setNotAfter(param.getExpiryTime());</span><br><span class="line">        licenseContent.setConsumerType(param.getConsumerType());</span><br><span class="line">        licenseContent.setConsumerAmount(param.getConsumerAmount());</span><br><span class="line">        licenseContent.setInfo(param.getDescription());</span><br><span class="line">        <span class="keyword">return</span> licenseContent;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>License生成类需要的参数类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LicenseCreatorParam</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 证书subject</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String subject;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 密钥别称</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String privateAlias;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 公钥密码（需要妥善保管，不能让使用者知道）</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String keyPass;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 私钥库的密码</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String storePass;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 证书生成路径</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String licensePath;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 私钥存储路径</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String privateKeysStorePath;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 证书生效时间</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@JsonFormat(pattern = &quot;yyyy-MM-dd HH:mm:ss&quot;, timezone = &quot;GMT+8&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> Date issuedTime;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 证书失效时间</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@JsonFormat(pattern = &quot;yyyy-MM-dd HH:mm:ss&quot;, timezone = &quot;GMT+8&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> Date expiryTime;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 用户类型</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String consumerType;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 用户数量</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Integer consumerAmount;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 描述信息</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String description;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>自定义KeyStoreParam</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CustomKeyStoreParam</span> <span class="keyword">extends</span> <span class="title class_">AbstractKeyStoreParam</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String storePath;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String alias;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String storePwd;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String keyPwd;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">CustomKeyStoreParam</span><span class="params">(Class clazz, String resource, String alias, String storePwd, String keyPwd)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(clazz, resource);</span><br><span class="line">        <span class="built_in">this</span>.storePath = resource;</span><br><span class="line">        <span class="built_in">this</span>.alias = alias;</span><br><span class="line">        <span class="built_in">this</span>.storePwd = storePwd;</span><br><span class="line">        <span class="built_in">this</span>.keyPwd = keyPwd;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getAlias</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> alias;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getStorePwd</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> storePwd;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getKeyPwd</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> keyPwd;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> InputStream <span class="title function_">getStream</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="keyword">return</span> Files.newInputStream(Paths.get(storePath));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="四、使用者配置"><a href="#四、使用者配置" class="headerlink" title="四、使用者配置"></a>四、使用者配置</h2><p>pom.xml</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- License --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>de.schlichtherle.truelicense<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>truelicense-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.33<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="1、License校验类"><a href="#1、License校验类" class="headerlink" title="1、License校验类"></a>1、License校验类</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LicenseVerify</span> &#123;</span><br><span class="line">    <span class="comment">// 安装License证书</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">synchronized</span> LicenseContent <span class="title function_">install</span><span class="params">(LicenseVerifyParam param)</span> &#123;</span><br><span class="line">        <span class="type">LicenseContent</span> <span class="variable">result</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="type">DateFormat</span> <span class="variable">format</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SimpleDateFormat</span>(<span class="string">&quot;yyyy-MM-dd HH:mm:ss&quot;</span>);</span><br><span class="line">        <span class="comment">// 1. 安装证书</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">LicenseManager</span> <span class="variable">licenseManager</span> <span class="operator">=</span> LicenseManagerHolder.getInstance(initLicenseParam(param));</span><br><span class="line">            licenseManager.uninstall();</span><br><span class="line">            result = licenseManager.install(<span class="keyword">new</span> <span class="title class_">File</span>(param.getLicensePath()));</span><br><span class="line">            log.info(MessageFormat.format(<span class="string">&quot;证书安装成功，证书有效期：&#123;0&#125; - &#123;1&#125;&quot;</span>, </span><br><span class="line">             format.format(result.getNotBefore()), format.format(result.getNotAfter())));</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;证书安装失败: &#123;&#125;&quot;</span>, e.getMessage());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 校验License证书</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">verify</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">LicenseManager</span> <span class="variable">licenseManager</span> <span class="operator">=</span> LicenseManagerHolder.getInstance(<span class="literal">null</span>);</span><br><span class="line">        <span class="type">DateFormat</span> <span class="variable">format</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SimpleDateFormat</span>(<span class="string">&quot;yyyy-MM-dd HH:mm:ss&quot;</span>);</span><br><span class="line">        <span class="comment">// 2. 校验证书</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">LicenseContent</span> <span class="variable">licenseContent</span> <span class="operator">=</span> licenseManager.verify();</span><br><span class="line">            log.info(MessageFormat.format(<span class="string">&quot;证书校验通过，证书有效期：&#123;0&#125; - &#123;1&#125;&quot;</span>, </span><br><span class="line">             format.format(licenseContent.getNotBefore()), format.format(licenseContent.getNotAfter())));</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;证书校验失败: &#123;&#125;&quot;</span>, e.getMessage());</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 初始化证书生成参数</span></span><br><span class="line">    <span class="keyword">private</span> LicenseParam <span class="title function_">initLicenseParam</span><span class="params">(LicenseVerifyParam param)</span> &#123;</span><br><span class="line">        <span class="type">Preferences</span> <span class="variable">preferences</span> <span class="operator">=</span> Preferences.userNodeForPackage(LicenseVerify.class);</span><br><span class="line">        <span class="type">CipherParam</span> <span class="variable">cipherParam</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultCipherParam</span>(param.getStorePass());</span><br><span class="line">        <span class="type">KeyStoreParam</span> <span class="variable">publicStoreParam</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CustomKeyStoreParam</span>(LicenseVerify.class</span><br><span class="line">                , param.getPublicKeysStorePath()</span><br><span class="line">                , param.getPublicAlias()</span><br><span class="line">                , param.getStorePass()</span><br><span class="line">                , <span class="literal">null</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">DefaultLicenseParam</span>(param.getSubject()</span><br><span class="line">                , preferences</span><br><span class="line">                , publicStoreParam</span><br><span class="line">                , cipherParam);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>License校验类需要的参数</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LicenseVerifyParam</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 证书subject</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String subject;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 公钥别称</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String publicAlias;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 访问公钥库的密码</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String storePass;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 证书生成路径</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String licensePath;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 密钥库存储路径</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String publicKeysStorePath;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>自定义KeyStoreParam（与授权者一样）</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CustomKeyStoreParam</span> <span class="keyword">extends</span> <span class="title class_">AbstractKeyStoreParam</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String storePath;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String alias;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String storePwd;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String keyPwd;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">CustomKeyStoreParam</span><span class="params">(Class clazz, String resource,String alias,String storePwd,String keyPwd)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(clazz, resource);</span><br><span class="line">        <span class="built_in">this</span>.storePath = resource;</span><br><span class="line">        <span class="built_in">this</span>.alias = alias;</span><br><span class="line">        <span class="built_in">this</span>.storePwd = storePwd;</span><br><span class="line">        <span class="built_in">this</span>.keyPwd = keyPwd;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getAlias</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> alias;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getStorePwd</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> storePwd;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getKeyPwd</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> keyPwd;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> InputStream <span class="title function_">getStream</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="keyword">return</span> Files.newInputStream(Paths.get(storePath));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>LicenseManager的单例</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LicenseManagerHolder</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">volatile</span> LicenseManager LICENSE_MANAGER;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> LicenseManager <span class="title function_">getInstance</span><span class="params">(LicenseParam param)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(LICENSE_MANAGER == <span class="literal">null</span>)&#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (LicenseManagerHolder.class)&#123;</span><br><span class="line">                <span class="keyword">if</span>(LICENSE_MANAGER == <span class="literal">null</span>)&#123;</span><br><span class="line">                    LICENSE_MANAGER = <span class="keyword">new</span> <span class="title class_">LicenseManager</span>(param);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> LICENSE_MANAGER;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="2、项目启动时安装证书"><a href="#2、项目启动时安装证书" class="headerlink" title="2、项目启动时安装证书"></a>2、项目启动时安装证书</h3><p>application.poperties配置</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#License配置</span></span><br><span class="line"><span class="comment"># 与创建license.lic设置的值一样</span></span><br><span class="line"><span class="string">license.subject=license</span></span><br><span class="line"><span class="comment"># 与生成密钥对的公钥别称一样</span></span><br><span class="line"><span class="string">license.publicAlias=publicCert</span></span><br><span class="line"><span class="comment"># 私钥库的密码</span></span><br><span class="line"><span class="string">license.storePass=public_password1234</span></span><br></pre></td></tr></table></figure>
<p>license.lic证书和publicCerts.keystore放入resources资源目录下<br>springboot项目启动后执行操作</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LicenseCheckRunner</span> <span class="keyword">implements</span> <span class="title class_">ApplicationRunner</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 证书subject</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;license.subject&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String subject;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 公钥别称</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;license.publicAlias&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String publicAlias;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 访问公钥库的密码</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;license.storePass&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String storePass;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">(ApplicationArguments args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        log.info(<span class="string">&quot;++++++++ 开始安装证书 ++++++++&quot;</span>);</span><br><span class="line">        <span class="type">LicenseVerifyParam</span> <span class="variable">param</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">LicenseVerifyParam</span>();</span><br><span class="line">        param.setSubject(subject);</span><br><span class="line">        param.setPublicAlias(publicAlias);</span><br><span class="line">        param.setStorePass(storePass);</span><br><span class="line">        <span class="comment">// 相对路径resources资源目录</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">resourcePath</span> <span class="operator">=</span> getClass().getClassLoader().getResource(<span class="string">&quot;&quot;</span>).getPath();</span><br><span class="line">        <span class="comment">// 证书地址</span></span><br><span class="line">        param.setLicensePath(resourcePath + <span class="string">&quot;license.lic&quot;</span>);</span><br><span class="line">        <span class="comment">// 公钥地址</span></span><br><span class="line">        param.setPublicKeysStorePath(resourcePath + <span class="string">&quot;publicCerts.keystore&quot;</span>);</span><br><span class="line">        <span class="comment">// 安装证书</span></span><br><span class="line">        <span class="type">LicenseVerify</span> <span class="variable">licenseVerify</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">LicenseVerify</span>();</span><br><span class="line">        licenseVerify.install(param);</span><br><span class="line">        log.info(<span class="string">&quot;++++++++ 证书安装结束 ++++++++&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果想要当前配置作为公共类，对于多个微服务，只想要一个服务resources&#x2F;license下配置证书和公钥</p>
<p>获取公共服务里证书和公钥的输入流，然后拷贝到当前服务下</p>
<h3 id="3、设置拦截器"><a href="#3、设置拦截器" class="headerlink" title="3、设置拦截器"></a>3、设置拦截器</h3><p>配置拦截器</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LicenseCheckInterceptor</span> <span class="keyword">implements</span> <span class="title class_">HandlerInterceptor</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">preHandle</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">LicenseVerify</span> <span class="variable">licenseVerify</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">LicenseVerify</span>();</span><br><span class="line">        <span class="comment">// 校验证书是否有效</span></span><br><span class="line">        <span class="type">boolean</span> <span class="variable">verifyResult</span> <span class="operator">=</span> licenseVerify.verify();</span><br><span class="line">        <span class="keyword">if</span> (verifyResult) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            response.setCharacterEncoding(<span class="string">&quot;utf-8&quot;</span>);</span><br><span class="line">            Map&lt;String, String&gt; result = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;(<span class="number">1</span>);</span><br><span class="line">            result.put(<span class="string">&quot;result&quot;</span>, <span class="string">&quot;您的证书无效，请核查服务器是否取得授权或重新申请证书！&quot;</span>);</span><br><span class="line">            response.getWriter().write(JSON.toJSONString(result));</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>注册拦截器</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WebMvcConfig</span> <span class="keyword">implements</span> <span class="title class_">WebMvcConfigurer</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addInterceptors</span><span class="params">(InterceptorRegistry registry)</span> &#123;</span><br><span class="line">        registry.addInterceptor(<span class="keyword">new</span> <span class="title class_">LicenseCheckInterceptor</span>());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
                
            </div>
        </article>
    
        <article class="post article-entry">
            <div class="post-title">
                <a class="post-title-link text-underline" href="/2024/06/19/409/">Java循环：for、foreach与stream性能对比</a>
            </div>
            <p class="sub">Jun 19 2024</p>
            <div class="post-content">
                
                    <h3 id="性能比较"><a href="#性能比较" class="headerlink" title="性能比较"></a>性能比较</h3><p>如果数据在1万以内的话，for循环效率高于foreach和stream；如果数据量在10万的时候，stream效率最高，其次是foreach，最后是for。</p>
<p>另外需要注意的是如果数据达到100万的话，parallelStream异步并行处理效率最高，高于foreach和for。</p>
<p>在效率方面，stream().forEach、forEach 和 parallelStream 之间存在一些差异。</p>
<h4 id="stream-forEach："><a href="#stream-forEach：" class="headerlink" title="stream().forEach："></a>stream().forEach：</h4><p>在处理大量数据时，使用 stream().forEach 可能会比普通的 forEach 更高效。这是因为 stream().forEach 可以使用流式操作，对数据进行更优化的处理，例如通过并行流或者其他优化手段来提高处理速度。</p>
<p>但是需要注意的是，stream().forEach 也可能会引入一些额外的性能开销，比如流的创建和操作过程中的一些额外计算。</p>
<h4 id="forEach："><a href="#forEach：" class="headerlink" title="forEach："></a>forEach：</h4><p>forEach 方法是集合类的默认方法，它通常会按照集合内部的数据结构进行遍历，不涉及额外的流式操作或并行处理。因此，在某些情况下，forEach 可能会比 stream().forEach 更加高效。</p>
<h4 id="parallelStream："><a href="#parallelStream：" class="headerlink" title="parallelStream："></a>parallelStream：</h4><p>parallelStream 方法可以在处理大量数据时提供更高的效率，因为它可以利用多核处理器并行处理数据。在某些情况下，特别是对于需要并行处理的大型数据集合，使用 parallelStream 可能会比顺序处理更加高效。</p>
<p>然而，并行处理也可能引入一些额外的开销，比如线程调度、同步等，因此并不是所有情况下都适合使用 parallelStream。</p>
<p>总的来说，对于数据量较小的情况，forEach 和 stream().forEach 的性能差异可能并不明显；而对于大型数据集合或需要并行处理的情况，考虑使用 parallelStream 可能会更加高效。在实际应用中，可以根据具体情况进行性能测试和选择合适的方法。</p>

                
            </div>
        </article>
    
        <article class="post article-entry">
            <div class="post-title">
                <a class="post-title-link text-underline" href="/2024/05/22/408/">SpringBoot如何实现缓存预热</a>
            </div>
            <p class="sub">May 22 2024</p>
            <div class="post-content">
                
                    <p>缓存预热是指在 Spring Boot 项目启动时，预先将数据加载到缓存系统（如 Redis）中的一种机制。</p>
<p>在 Spring Boot 启动之后，可以通过以下手段实现缓存预热：</p>
<ul>
<li>使用启动监听事件实现缓存预热。</li>
<li>使用 @PostConstruct 注解实现缓存预热。</li>
<li>使用 CommandLineRunner 或 ApplicationRunner 实现缓存预热。</li>
<li>通过实现 InitializingBean 接口，并重写 afterPropertiesSet 方法实现缓存预热。</li>
<li>具体实现方案</li>
</ul>
<h3 id="1、启动监听事件"><a href="#1、启动监听事件" class="headerlink" title="1、启动监听事件"></a>1、启动监听事件</h3><p>可以使用 ApplicationListener 监听 ContextRefreshedEvent 或 ApplicationReadyEvent 等应用上下文初始化完成事件，在这些事件触发后执行数据加载到缓存的操作，具体实现如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CacheWarmer</span> <span class="keyword">implements</span> <span class="title class_">ApplicationListener</span>&lt;ContextRefreshedEvent&gt; &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onApplicationEvent</span><span class="params">(ContextRefreshedEvent event)</span> &#123;</span><br><span class="line">        <span class="comment">// 执行缓存预热业务...</span></span><br><span class="line">        cacheManager.put(<span class="string">&quot;key&quot;</span>, dataList);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>或监听 ApplicationReadyEvent 事件，如下代码所示：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CacheWarmer</span> <span class="keyword">implements</span> <span class="title class_">ApplicationListener</span>&lt;ApplicationReadyEvent&gt; &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onApplicationEvent</span><span class="params">(ApplicationReadyEvent event)</span> &#123;</span><br><span class="line">        <span class="comment">// 执行缓存预热业务...</span></span><br><span class="line">        cacheManager.put(<span class="string">&quot;key&quot;</span>, dataList);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="2、-PostConstruct-注解"><a href="#2、-PostConstruct-注解" class="headerlink" title="2、@PostConstruct 注解"></a>2、@PostConstruct 注解</h3><p>在需要进行缓存预热的类上添加 @Component 注解，并在其方法中添加 @PostConstruct 注解和缓存预热的业务逻辑，具体实现代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CachePreloader</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> YourCacheManager cacheManager;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostConstruct</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">preloadCache</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// 执行缓存预热业务...</span></span><br><span class="line">        cacheManager.put(<span class="string">&quot;key&quot;</span>, dataList);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="3、CommandLineRunner或ApplicationRunner"><a href="#3、CommandLineRunner或ApplicationRunner" class="headerlink" title="3、CommandLineRunner或ApplicationRunner"></a>3、CommandLineRunner或ApplicationRunner</h3><p>CommandLineRunner 和 ApplicationRunner 都是 Spring Boot 应用程序启动后要执行的接口，它们都允许我们在应用启动后执行一些自定义的初始化逻辑，例如缓存预热。CommandLineRunner 实现示例如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyCommandLineRunner</span> <span class="keyword">implements</span> <span class="title class_">CommandLineRunner</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">(String... args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// 执行缓存预热业务...</span></span><br><span class="line">        cacheManager.put(<span class="string">&quot;key&quot;</span>, dataList);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ApplicationRunner 实现示例如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyApplicationRunner</span> <span class="keyword">implements</span> <span class="title class_">ApplicationRunner</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">(ApplicationArguments args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// 执行缓存预热业务...</span></span><br><span class="line">        cacheManager.put(<span class="string">&quot;key&quot;</span>, dataList);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="CommandLineRunner-和-ApplicationRunner-区别如下："><a href="#CommandLineRunner-和-ApplicationRunner-区别如下：" class="headerlink" title="CommandLineRunner 和 ApplicationRunner 区别如下："></a>CommandLineRunner 和 ApplicationRunner 区别如下：</h4><ul>
<li>方法签名不同：<br>CommandLineRunner 接口有一个 run(String… args) 方法，它接收命令行参数作为可变长度字符串数组。<br>ApplicationRunner 接口则提供了一个 run(ApplicationArguments args) 方法，它接收一个 ApplicationArguments 对象作为参数，这个对象提供了对传入的所有命令行参数（包括选项和非选项参数）的访问。</li>
<li>参数解析方式不同：<br>CommandLineRunner 接口更简单直接，适合处理简单的命令行参数。<br>ApplicationRunner 接口提供了一种更强大的参数解析能力，可以通过 ApplicationArguments 获取详细的参数信息，比如获取选项参数及其值、非选项参数列表以及查询是否存在特定参数等。</li>
<li>使用场景不同：<br>当只需要处理一组简单的命令行参数时，可以使用 CommandLineRunner。<br>对于需要精细控制和解析命令行参数的复杂场景，推荐使用 ApplicationRunner。</li>
</ul>
<h3 id="4、实现InitializingBean接口"><a href="#4、实现InitializingBean接口" class="headerlink" title="4、实现InitializingBean接口"></a>4、实现InitializingBean接口</h3><p>实现 InitializingBean 接口并重写 afterPropertiesSet 方法，可以在 Spring Bean 初始化完成后执行缓存预热，具体实现代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CachePreloader</span> <span class="keyword">implements</span> <span class="title class_">InitializingBean</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> YourCacheManager cacheManager;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">afterPropertiesSet</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// 执行缓存预热业务...</span></span><br><span class="line">        cacheManager.put(<span class="string">&quot;key&quot;</span>, dataList);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h3><p>缓存预热是指在 Spring Boot 项目启动时，预先将数据加载到缓存系统（如 Redis）中的一种机制。它可以通过监听 ContextRefreshedEvent 或 ApplicationReadyEvent 启动事件，或使用 @PostConstruct 注解，或实现 CommandLineRunner 接口、ApplicationRunner 接口，和 InitializingBean 接口的方式来完成。</p>

                
            </div>
        </article>
    
        <article class="post article-entry">
            <div class="post-title">
                <a class="post-title-link text-underline" href="/2024/05/21/407/">Java中“100=100”为true，而&#34;1000=1000&#34;为false？</a>
            </div>
            <p class="sub">May 21 2024</p>
            <div class="post-content">
                
                    <h3 id="1-自动装箱与缓存机制"><a href="#1-自动装箱与缓存机制" class="headerlink" title="1. 自动装箱与缓存机制"></a>1. 自动装箱与缓存机制</h3><p>在 Java 中，整数值在 -128 到 127 之间时，Integer 类会缓存这些值。即在这个范围内的整数会共享同一个对象实例。因此，当两个整数在该范围内进行比较时（如 100 &#x3D;&#x3D; 100），返回的是 true，因为它们指向的是相同的缓存对象。</p>
<h3 id="2-大于-127-的整数不共享同一实例"><a href="#2-大于-127-的整数不共享同一实例" class="headerlink" title="2. 大于 127 的整数不共享同一实例"></a>2. 大于 127 的整数不共享同一实例</h3><p>超过 127 的整数不在缓存范围内，因此每次装箱都会创建一个新的 Integer 对象。所以对于 “1000&#x3D;1000”，两个 Integer 对象的地址不同，因此 &#x3D;&#x3D; 比较返回 false。</p>
<h3 id="示例代码"><a href="#示例代码" class="headerlink" title="示例代码"></a>示例代码</h3><p>以下代码演示了 Integer 的缓存机制：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">复制代码</span><br><span class="line"><span class="type">Integer</span> <span class="variable">a</span> <span class="operator">=</span> <span class="number">100</span>;</span><br><span class="line"><span class="type">Integer</span> <span class="variable">b</span> <span class="operator">=</span> <span class="number">100</span>;</span><br><span class="line">System.out.println(a == b); <span class="comment">// true</span></span><br><span class="line"></span><br><span class="line"><span class="type">Integer</span> <span class="variable">c</span> <span class="operator">=</span> <span class="number">1000</span>;</span><br><span class="line"><span class="type">Integer</span> <span class="variable">d</span> <span class="operator">=</span> <span class="number">1000</span>;</span><br><span class="line">System.out.println(c == d); <span class="comment">// false</span></span><br></pre></td></tr></table></figure>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>Integer 缓存范围：-128 到 127。<br>在这个范围内，比较两个相等的 Integer 返回 true。<br>超出范围时，装箱生成的新对象实例地址不同，比较返回 false。<br>因此，比较整数时，推荐使用 equals() 方法而非 &#x3D;&#x3D;。</p>

                
            </div>
        </article>
    
        <article class="post article-entry">
            <div class="post-title">
                <a class="post-title-link text-underline" href="/2024/05/20/406/">并发环境下数据库和缓存操作问题</a>
            </div>
            <p class="sub">May 20 2024</p>
            <div class="post-content">
                
                    <p>#缓存维护总结<br>综上所述，在分布式系统中，缓存和数据库同时存在时，如果有写操作的时候，先操作数据库，再操作缓存。如下：</p>
<p>（1）读取缓存中是否有相关数据</p>
<p>（2）如果缓存中有相关数据value，则返回</p>
<p>（3）如果缓存中没有相关数据，则从数据库读取相关数据放入缓存中key-&gt;value，再返回</p>
<p>（4）如果有更新数据，则先更新数据，再删除缓存</p>
<p>（5）为了保证第四步删除缓存成功，使用binlog异步删除</p>
<p>（6）如果是主从数据库，binglog取自于从库</p>
<p>（7）如果是一主多从，每个从库都要采集binlog，然后消费端收到最后一台binlog数据才删除缓存</p>

                
            </div>
        </article>
    
        <article class="post article-entry">
            <div class="post-title">
                <a class="post-title-link text-underline" href="/2024/03/20/405/">大事务优化</a>
            </div>
            <p class="sub">Mar 20 2024</p>
            <div class="post-content">
                
                    <h3 id="1、事务里面不要进行远程RPC调用"><a href="#1、事务里面不要进行远程RPC调用" class="headerlink" title="1、事务里面不要进行远程RPC调用"></a>1、事务里面不要进行远程RPC调用</h3><p>首先事务里面进行远程的接口调用，如果不采用分布式事务框架，本身就会存在事务不一致的情况，无法进行数据的回滚操作，并发情况下远程服务响应不及时，会出现接口返回不一致问题，当然必须采用异步调用</p>
<h3 id="2、编程型事务更加灵活"><a href="#2、编程型事务更加灵活" class="headerlink" title="2、编程型事务更加灵活"></a>2、编程型事务更加灵活</h3><p>声明式事务只需要加在方法头加@Transactional注解即可开启事务，但是还是不太灵活，意味着整个方法所进行对数据库操作都要加进事务，当然一次查询也要进入事务，这并不是我们想要的，我们在update、insert操作上进行事务操作，方便进行回滚。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Boolean <span class="title function_">transactionCommit</span><span class="params">(String userName)</span> &#123;</span><br><span class="line">    <span class="comment">//查询用户</span></span><br><span class="line">    <span class="type">SysUser</span> <span class="variable">sysUser</span> <span class="operator">=</span> userMapper.selectUserByUserName(userName,<span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">    transactionTemplate.execute(<span class="keyword">new</span> <span class="title class_">TransactionCallbackWithoutResult</span>() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">doInTransactionWithoutResult</span><span class="params">(TransactionStatus transactionStatus)</span> &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (<span class="literal">null</span> != sysUser) &#123;</span><br><span class="line">                    <span class="comment">//用户信息状态更新 status更新为1</span></span><br><span class="line">                    userMapper.updateStatus(userName);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">                <span class="comment">//回滚</span></span><br><span class="line">                transactionStatus.setRollbackOnly();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="comment">//再次查询</span></span><br><span class="line">    <span class="type">SysUser</span> <span class="variable">sysUser1</span> <span class="operator">=</span> userMapper.selectUserByUserName(userName,<span class="string">&quot;1&quot;</span>);</span><br><span class="line">    /log/.info(<span class="string">&quot;状态为1的用户信息&quot;</span>+JSON./toJSONString/(sysUser1));</span><br><span class="line">    <span class="keyword">return</span>  <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>编程式事务的灵活点在于可以控制事务执行方法，运用transactionTemplate类进行事务操作，查询操作可以写在外面，这样查询获取数据的操作就不会进入mysql事务表。</p>
<h3 id="3、数据分批处理"><a href="#3、数据分批处理" class="headerlink" title="3、数据分批处理"></a>3、数据分批处理</h3><p>对于事务的更新或者插入，前端可能会有批量操作，大规模数据的批量更新、插入也会对事务接口产生影响，一旦其中有更新或插入失败，为了保证事务的一致性，整个操作都要进行回滚；</p>
<ul>
<li>前端：可以限制数据，对后端接口的访问，可以将数据进行分页，多次请求，可以避免事务提交大量数据。</li>
<li>后端：也可以去数据进行分页处理，例如每次可以限制50条进行操作，如果是新增逻辑，使用Mybatis的批量更新大大提升效率<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">List&lt;List&lt;ReceivableFeeSaveDTO&gt;&gt; partition = Lists.partition(receivableFeeSaveDTOList, <span class="number">50</span>);</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="4、大事务拆分小事务"><a href="#4、大事务拆分小事务" class="headerlink" title="4、大事务拆分小事务"></a>4、大事务拆分小事务</h3><p>可以将一个事务接口，拆分成多个事务接口，并且每个事务接口只做一件事，比如上面的收款单生成接口，金额回写、第三方接口调用、调用后的结果回写都可以抽成一个哥小事务接口。</p>
<h3 id="5、异步并行处理"><a href="#5、异步并行处理" class="headerlink" title="5、异步并行处理"></a>5、异步并行处理</h3><p>重中之重，事务里如果无法避免远程调用，那么肯定是需要进行异步调用，因为无法保证远程接口的及时响应性，CompletableFuture异步编排特性可以用到，task1和task2任务结束后，执行task3。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">CompletableFuture&lt;Object&gt; task1 =CompletableFuture.supplyAsync(() -&gt; &#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;单号check线程&quot;</span> + Thread.currentThread().getId());</span><br><span class="line">    <span class="comment">//单号check接口 校验失败抛出异常</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;账单实体信息&quot;</span>;</span><br><span class="line">&#125;, executor);</span><br><span class="line">CompletableFuture&lt;Object&gt; task2 = CompletableFuture.supplyAsync(() -&gt; &#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;收款单生成线程&quot;</span> + Thread.currentThread().getId());</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">//收款单生成</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> “账单编号”;</span><br><span class="line">        Thread.sleep(<span class="number">3000</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;任务2结束：&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;, executor);</span><br><span class="line"></span><br><span class="line"> <span class="comment">//task1、task2 执行完执行task3 ,需要感知task1和task2的执行结果</span></span><br><span class="line">CompletableFuture&lt;Boolean&gt; future = task1.thenCombineAsync(task2, (t1, t2) -&gt; &#123;</span><br><span class="line"></span><br><span class="line">    System.out.println(<span class="string">&quot;账单金额回写线程&quot;</span> + Thread.currentThread().getId());</span><br><span class="line">    <span class="comment">// t1 、t2返回判断</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//回写返回结果</span></span><br><span class="line">    <span class="keyword">return</span> ture;</span><br><span class="line">&#125;, executor);</span><br></pre></td></tr></table></figure>
                
            </div>
        </article>
    
        <article class="post article-entry">
            <div class="post-title">
                <a class="post-title-link text-underline" href="/2024/03/18/404/">Spring中事务失效的8中场景</a>
            </div>
            <p class="sub">Mar 18 2024</p>
            <div class="post-content">
                
                    <h3 id="1-数据库引擎不支持事务"><a href="#1-数据库引擎不支持事务" class="headerlink" title="1. 数据库引擎不支持事务"></a>1. 数据库引擎不支持事务</h3><h3 id="2-没有被-Spring-管理"><a href="#2-没有被-Spring-管理" class="headerlink" title="2.没有被 Spring 管理"></a>2.没有被 Spring 管理</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">OrderService</span>&#123;</span><br><span class="line">  <span class="meta">@Transactional</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">updateOrder</span><span class="params">(Order order)</span>&#123;</span><br><span class="line">    <span class="comment">//update order</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果此时把@Service注解注释掉，那么这个类就不会被加载成一个Bean，这个类就不会Spring管理了，事务自然就失效了。</p>
<h3 id="3-方法不是-public-的"><a href="#3-方法不是-public-的" class="headerlink" title="3. 方法不是 public 的"></a>3. 方法不是 public 的</h3><p>@Transactional注解只能用干public 的方法上，否则事多不会生效，如果要用在非public的方法上，则可以开启基于 AspcetJ 框架的静态代理模式。</p>
<h3 id="4-发生自身调用"><a href="#4-发生自身调用" class="headerlink" title="4.发生自身调用"></a>4.发生自身调用</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">OrderService</span> &#123;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">update</span><span class="params">(Order order)</span> &#123;</span><br><span class="line">    updateOrder(order);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">updateOrder</span><span class="params">(0rder order)</span> &#123;</span><br><span class="line">    <span class="comment">// update order</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>update 方法上面没有加 @Transactional 注解，如果调用有 @Transactional 注解的updateOrder 方法，那么 updateOrder 方法上的事务还可以生效吗?   这里大家可以先想一想，后面会揭晓答案。</p>
<h3 id="5-没有配置事务管理器"><a href="#5-没有配置事务管理器" class="headerlink" title="5.没有配置事务管理器"></a>5.没有配置事务管理器</h3><p>如果没有配置以下DataSourceTransactionManager数据源事务管理器，那么事务也不会生效 ：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">@Bean</span><br><span class="line">public PlatformTransactionManager transactionManager(DataSource dataSource) &#123;</span><br><span class="line">  return new DataSourceTransactionManager(dataSource);</span><br><span class="line">&#125;  </span><br></pre></td></tr></table></figure>

<h3 id="6-设置了不支持事务"><a href="#6-设置了不支持事务" class="headerlink" title="6. 设置了不支持事务"></a>6. 设置了不支持事务</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">OrderService</span> &#123;</span><br><span class="line">  <span class="meta">@Transactional</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">update</span><span class="params">(Order order)</span> &#123;</span><br><span class="line">    updateOrder(order);</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="meta">@Transactional(propagation = Propagation.NOT_SUPPORTED)</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">updateOrder</span><span class="params">(Order order)</span> &#123;</span><br><span class="line">    <span class="comment">//update order</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">这里的Propagation.NOT_SUPPORTED表示当前方法不以事务方式运行，当前若存在事务则挂起，这就是主动不支持以事务方式运行了。</span><br></pre></td></tr></table></figure>
<h3 id="7-异常没有被抛出"><a href="#7-异常没有被抛出" class="headerlink" title="7. 异常没有被抛出"></a>7. 异常没有被抛出</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">OrderService</span> &#123;</span><br><span class="line">  <span class="meta">@Transactional</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">update</span><span class="params">(Order order)</span> &#123;</span><br><span class="line">    <span class="keyword">try</span>&#123;</span><br><span class="line">      <span class="comment">// update order</span></span><br><span class="line">    &#125;<span class="keyword">catch</span>&#123;</span><br><span class="line">      </span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="8-异常类型不匹配"><a href="#8-异常类型不匹配" class="headerlink" title="8. 异常类型不匹配"></a>8. 异常类型不匹配</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">OrderService</span> &#123;</span><br><span class="line">  <span class="meta">@Transactional</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">update</span><span class="params">(Order order)</span> &#123;</span><br><span class="line">    <span class="keyword">try</span>&#123;</span><br><span class="line">      <span class="comment">// update order</span></span><br><span class="line">    &#125;<span class="keyword">catch</span>&#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Exception</span>(<span class="string">&quot;更新失败&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>因为 Spring 默认回滚的是 RuntimeException 异常，和程序抛出的 Exception 异常不匹配，所以事务也是不生效的。如果要触发默认 RuntimeException之外异常的回滚，则需要在 @Transactiona事务注解上指定异常类，示例如下:<br>@Transactional(rollbackFor &#x3D; Exception.class)</p>

                
            </div>
        </article>
    
        <article class="post article-entry">
            <div class="post-title">
                <a class="post-title-link text-underline" href="/2024/02/24/403/">微服务开发时，接口不能对外暴</a>
            </div>
            <p class="sub">Feb 24 2024</p>
            <div class="post-content">
                
                    <h3 id="一-网关-白名单"><a href="#一-网关-白名单" class="headerlink" title="一. 网关+白名单"></a>一. 网关+白名单</h3><p>此方案需要在缓存中维护一套接口白名单，请求到达网关处，先判断白名单缓存中是否存在，存在则放行，反之则拦截。<br>该方案的好处是，对业务代码零侵入，只需要维护好白名单列表即可；</p>
<p>不足之处在于，白名单的维护是一个持续性投入的工作，在很多公司，业务开发无法直接触及到 redis，只能提工单申请，增加了开发成本；</p>
<p>另外，每次请求进来，都需要判断白名单，增加了系统响应耗时，考虑到正常情况下外部进来的请求大部分都是在白名单内的，只有极少数恶意请求才会被白名单机制所拦截，所以该方案的性价比很低。</p>
<h3 id="二-网关-AOP"><a href="#二-网关-AOP" class="headerlink" title="二. 网关+AOP"></a>二. 网关+AOP</h3><p>相比于方案一对接口进行白名单判断而言，方案二是对请求来源进行判断，并将该判断下沉到业务侧。避免了网关侧的逻辑判断，从而提升系统响应速度。</p>
<p>我们可以在所有内部的调用请求头中增加一个header标志这是一个内部请求，比如加个请求头：from&#x3D;Y</p>
<p>只要在业务接口处通过AOP的方式判断一下请求头中是否含有from&#x3D;Y，如果有，则是内部请求，反之则是外部请求</p>
<h4 id="1-定义注解"><a href="#1-定义注解" class="headerlink" title="1. 定义注解"></a>1. 定义注解</h4><p>这里AOP在码猿慢病云管理系统中采用的是注解的方式，注解如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Target(&#123; ElementType.METHOD, ElementType.TYPE &#125;)</span></span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> Inner &#123;</span><br><span class="line"> <span class="comment">/**</span></span><br><span class="line"><span class="comment">  * 是否AOP统一处理</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"> <span class="type">boolean</span> <span class="title function_">value</span><span class="params">()</span> <span class="keyword">default</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="2-网关处理"><a href="#2-网关处理" class="headerlink" title="2. 网关处理"></a>2. 网关处理</h4><p>在网关处需要对请求头中的from进行清洗，避免有意之人伪装内部请求，这里需要做的就是对每个请求直接移除from这个请求头，直接使用全局过滤器即可完成，代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &#123;<span class="doctag">@link</span> com.code.ape.codeape.gateway.filter.CodeapeRequestGlobalFilter#filter&#125;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CodeapeRequestGlobalFilter</span> <span class="keyword">implements</span> <span class="title class_">GlobalFilter</span>, Ordered &#123;</span><br><span class="line"></span><br><span class="line"> <span class="meta">@Override</span></span><br><span class="line"> <span class="keyword">public</span> Mono&lt;Void&gt; <span class="title function_">filter</span><span class="params">(ServerWebExchange exchange, GatewayFilterChain chain)</span> &#123;</span><br><span class="line">  <span class="comment">// 1. 清洗请求头中from 参数</span></span><br><span class="line">  <span class="type">ServerHttpRequest</span> <span class="variable">request</span> <span class="operator">=</span> exchange.getRequest().mutate().headers(httpHeaders -&gt; &#123;</span><br><span class="line">   httpHeaders.remove(SecurityConstants.FROM);</span><br><span class="line">   <span class="comment">// 设置请求时间</span></span><br><span class="line">   httpHeaders.put(CommonConstants.REQUEST_START_TIME,</span><br><span class="line">     Collections.singletonList(String.valueOf(System.currentTimeMillis())));</span><br><span class="line">  &#125;).build();</span><br><span class="line">        .......</span><br><span class="line">        .......</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h4 id="3-feign接口处理"><a href="#3-feign接口处理" class="headerlink" title="3. feign接口处理"></a>3. feign接口处理</h4><p>既然是内部调用，按照之前的约定是要在请求头中添加一个from&#x3D;Y，因此在feign接口中需要新增这个请求头，方式很简单，比如设备feign接口，如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> 设备的feign接口</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@FeignClient(contextId = &quot;remoteDeviceService&quot;, value = ServiceNameConstants.DEVICE_SERVICE)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">RemoteDeviceService</span> &#123;</span><br><span class="line"></span><br><span class="line"> <span class="comment">/**</span></span><br><span class="line"><span class="comment">  * 通过Sn查询</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@param</span> sn 设备SN号</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@return</span> 设备详细信息</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"> <span class="meta">@GetMapping(value = &quot;/device/sn/&#123;sn&#125;&quot;,headers = &quot;from=Y&quot;)</span></span><br><span class="line"> R&lt;DeviceInfoVO&gt; <span class="title function_">getBySn</span><span class="params">(<span class="meta">@PathVariable(&quot;sn&quot; )</span> String sn)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>@GetMapping中的headers属性即可完成新增请求头，同样的比如@RequestMapping、@PostMapping等也是支持的。</p>
<p>这样的话在feign接口发出请求时则会自动在请求头中新增from&#x3D;Y了。</p>
<h4 id="4-AOP处理"><a href="#4-AOP处理" class="headerlink" title="4. AOP处理"></a>4. AOP处理</h4><p>在第1步中定义了@Inner这个注解，标注在controller方法上表示这个接口只允许内部调用</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//com.code.ape.codeape.common.security.component.CodeapeSecurityInnerAspect</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Aspect</span></span><br><span class="line"><span class="meta">@RequiredArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CodeapeSecurityInnerAspect</span> <span class="keyword">implements</span> <span class="title class_">Ordered</span> &#123;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">private</span> <span class="keyword">final</span> HttpServletRequest request;</span><br><span class="line"></span><br><span class="line"> <span class="meta">@SneakyThrows</span></span><br><span class="line"> <span class="meta">@Around(&quot;@within(inner) || @annotation(inner)&quot;)</span></span><br><span class="line"> <span class="keyword">public</span> Object <span class="title function_">around</span><span class="params">(ProceedingJoinPoint point, Inner inner)</span> &#123;</span><br><span class="line">        <span class="comment">//取出请求头中的from属性</span></span><br><span class="line">  <span class="type">String</span> <span class="variable">header</span> <span class="operator">=</span> request.getHeader(<span class="string">&quot;from&quot;</span>);</span><br><span class="line">        <span class="comment">//判断from===Y</span></span><br><span class="line">  <span class="keyword">if</span> (inner.value() &amp;&amp; !<span class="string">&quot;Y&quot;</span>.equals(header)) &#123;</span><br><span class="line">            <span class="comment">//不符合规则，直接抛出异常，返回给客户端无权限</span></span><br><span class="line">   log.warn(<span class="string">&quot;访问接口 &#123;&#125; 没有权限&quot;</span>, point.getSignature().getName());</span><br><span class="line">   <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">AccessDeniedException</span>(<span class="string">&quot;Access is denied&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> point.proceed();</span><br><span class="line"> &#125;</span><br><span class="line">    .......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果请求头中的from属性不匹配，则抛出AccessDeniedException异常，会被全局异常捕获，返回403的状态码</p>

                
            </div>
        </article>
    
        <article class="post article-entry">
            <div class="post-title">
                <a class="post-title-link text-underline" href="/2024/02/23/402/">Spring File Storag简单使用</a>
            </div>
            <p class="sub">Feb 23 2024</p>
            <div class="post-content">
                
                    <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- spring-file-storage 必须要引入 --&gt;</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;cn.xuyanwu&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;spring-file-storage&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;0.5.0&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br><span class="line"></span><br><span class="line">&lt;!-- 阿里云oss --&gt;</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;com.aliyun.oss&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;aliyun-sdk-oss&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;3.10.2&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure>
<p>application.yml文件中配置些基础信息。</p>
<p>enable-storage：只有状态开启才会被识别到<br>default-platform：默认的上传平台<br>domain：生成的文件url中访问的域名<br>base-path：存储地址<br>thumbnail-suffix：缩略图后缀<br>要是上传OSS对象存储平台，将aliyun oss提供的变量配置到相应的模块上即可。</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="comment">#文件存储配置(本地、oss)</span></span><br><span class="line">  <span class="attr">file-storage:</span></span><br><span class="line">    <span class="attr">default-platform:</span> <span class="string">local-1</span></span><br><span class="line">    <span class="attr">thumbnail-suffix:</span> <span class="string">&quot;.min.jpg&quot;</span> <span class="comment">#缩略图后缀</span></span><br><span class="line">    <span class="attr">local:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">platform:</span> <span class="string">local-1</span> <span class="comment"># 存储平台标识</span></span><br><span class="line">        <span class="attr">enable-storage:</span> <span class="literal">true</span> <span class="comment">#是否开启本存储（只能选一种）</span></span><br><span class="line">        <span class="attr">enable-access:</span> <span class="literal">true</span> <span class="comment">#启用访问（线上请使用 Nginx 配置，效率更高）</span></span><br><span class="line">        <span class="attr">domain:</span> <span class="string">&quot;http://127.0.0.1:2222&quot;</span> <span class="comment">#访问域名，注意后面要和path-patterns保持一致，“/”结尾</span></span><br><span class="line">        <span class="attr">base-path:</span> <span class="string">/tmp/Pictures/</span> <span class="comment"># 存储地址</span></span><br><span class="line">        <span class="attr">path-patterns:</span> <span class="string">/**</span> <span class="comment">#访问路径</span></span><br><span class="line">    <span class="attr">aliyun-oss:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">platform:</span> <span class="string">aliyun-oss</span></span><br><span class="line">        <span class="attr">enable-storage:</span> <span class="literal">true</span></span><br><span class="line">        <span class="attr">access-key:</span> <span class="string">xxxx</span></span><br><span class="line">        <span class="attr">secret-key:</span> <span class="string">xxxx</span></span><br><span class="line">        <span class="attr">end-point:</span> <span class="string">xxx</span></span><br><span class="line">        <span class="attr">bucket-name:</span> <span class="string">firebook</span></span><br><span class="line">        <span class="attr">domain:</span> <span class="string">http://fire100.top</span></span><br><span class="line">        <span class="attr">base-path:</span> <span class="comment">#云平台文件路径</span></span><br></pre></td></tr></table></figure>
<p>springboot启动类中增加注解@EnableFileStorage，显式的开启文件上传功能，到这就可以用了</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableFileStorage</span> <span class="comment">// 文件上传工具</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SpringbootFileStorageApplication</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(SpringbootFileStorageApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">上传文件</span><br><span class="line">接下来在业务类中引入FileStorageService服务，如下只要一行代码就可以完成文件上传，是不是So easy，下载也是如法炮制。</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FileController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> FileStorageService fileStorageService;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 上传文件</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@PostMapping(value = &#123;&quot;/upload&quot;&#125;)</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">upload</span><span class="params">(MultipartFile file)</span> &#123;</span><br><span class="line">        <span class="type">FileInfo</span> <span class="variable">upload</span>  <span class="operator">=</span> fileStorageService.of(file).upload();</span><br><span class="line">        <span class="keyword">return</span> upload;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>不仅如此spring-file-storage还支持多种文件形式，URI、URL、String、byte[]、InputStream、MultipartFile，使开发更加灵活。<br>件上传功能，更多时候我们都是在上传图片，那就会有动态裁剪图片、生成缩略图的需求，这些 spring-file-storage 都可以很容易实现。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 上传图片裁剪大小并生成一张缩略图</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@PostMapping(&quot;/uploadThumbnail&quot;)</span></span><br><span class="line"><span class="keyword">public</span> FileInfo <span class="title function_">uploadThumbnail</span><span class="params">(MultipartFile file)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> fileStorageService.of(file)</span><br><span class="line">            .image(img -&gt; img.size(<span class="number">1000</span>,<span class="number">1000</span>))  <span class="comment">//将图片大小调整到 1000*1000</span></span><br><span class="line">            .thumbnail(th -&gt; th.size(<span class="number">200</span>,<span class="number">200</span>))  <span class="comment">//再生成一张 200*200 的缩略图</span></span><br><span class="line">            .upload();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>而且我们还可以动态选择上传平台，配置文件中将所有平台开启，在实际使用中自由的选择。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 上传文件到指定存储平台，成功返回文件信息</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@PostMapping(&quot;/upload-platform&quot;)</span></span><br><span class="line"><span class="keyword">public</span> FileInfo <span class="title function_">uploadPlatform</span><span class="params">(MultipartFile file)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> fileStorageService.of(file)</span><br><span class="line">            .setPlatform(<span class="string">&quot;aliyun-oss&quot;</span>)    <span class="comment">//使用指定的存储平台</span></span><br><span class="line">            .upload();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="下载文件"><a href="#下载文件" class="headerlink" title="下载文件"></a>下载文件</h3><p>下载文件也同样的简单，可以直接根据文件url或者文件流下载。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 下载文件</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@PostMapping(&quot;/download&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">download</span><span class="params">(MultipartFile file)</span> &#123;</span><br><span class="line">    <span class="comment">// 获取文件信息</span></span><br><span class="line">    <span class="type">FileInfo</span> <span class="variable">fileInfo</span> <span class="operator">=</span> fileStorageService.getFileInfoByUrl(<span class="string">&quot;http://file.abc.com/test/a.jpg&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 下载到文件</span></span><br><span class="line">    fileStorageService.download(fileInfo).file(<span class="string">&quot;C:\\a.jpg&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 直接通过文件信息中的 url 下载，省去手动查询文件信息记录的过程</span></span><br><span class="line">    fileStorageService.download(<span class="string">&quot;http://file.abc.com/test/a.jpg&quot;</span>).file(<span class="string">&quot;C:\\a.jpg&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 下载缩略图</span></span><br><span class="line">    fileStorageService.downloadTh(fileInfo).file(<span class="string">&quot;C:\\th.jpg&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line">提供了监听下载进度的功能，可以清晰明了的掌握文件的下载情况。</span><br><span class="line"></span><br><span class="line"><span class="comment">// 下载文件 显示进度</span></span><br><span class="line">fileStorageService.download(fileInfo).setProgressMonitor(<span class="keyword">new</span> <span class="title class_">ProgressListener</span>() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">start</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;下载开始&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">progress</span><span class="params">(<span class="type">long</span> progressSize,<span class="type">long</span> allSize)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;已下载 &quot;</span> + progressSize + <span class="string">&quot; 总大小&quot;</span> + allSize);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">finish</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;下载结束&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;).file(<span class="string">&quot;C:\\a.jpg&quot;</span>);</span><br></pre></td></tr></table></figure>
<h3 id="文件存在、删除"><a href="#文件存在、删除" class="headerlink" title="文件存在、删除"></a>文件存在、删除</h3><p>我们还可以根据文件的URL地址来判断文件是否存在、以及删除文件。</p>
<p>&#x2F;&#x2F;直接通过文件信息中的 url 删除，省去手动查询文件信息记录的过程<br>fileStorageService.delete(“<a target="_blank" rel="noopener" href="http://file.abc.com/test/a.jpg">http://file.abc.com/test/a.jpg</a>“);<br>&#x2F;&#x2F;直接通过文件信息中的 url 判断文件是否存在，省去手动查询文件信息记录的过程<br>boolean exists2 &#x3D; fileStorageService.exists(“<a target="_blank" rel="noopener" href="http://file.abc.com/test/a.jpg">http://file.abc.com/test/a.jpg</a>“);</p>
<p>切面工具还提供了每种操作的切面，可以在每个动作的前后进行干预，比如打日志或者玩点花活，实现FileStorageAspect类重写对应动作的xxxAround方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 使用切面打印文件上传和删除的日志</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LogFileStorageAspect</span> <span class="keyword">implements</span> <span class="title class_">FileStorageAspect</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 上传，成功返回文件信息，失败返回 null</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> FileInfo <span class="title function_">uploadAround</span><span class="params">(UploadAspectChain chain, FileInfo fileInfo, UploadPretreatment pre, FileStorage fileStorage, FileRecorder fileRecorder)</span> &#123;</span><br><span class="line">        log.info(<span class="string">&quot;上传文件 before -&gt; &#123;&#125;&quot;</span>,fileInfo);</span><br><span class="line">        fileInfo = chain.next(fileInfo,pre,fileStorage,fileRecorder);</span><br><span class="line">        log.info(<span class="string">&quot;上传文件 after -&gt; &#123;&#125;&quot;</span>,fileInfo);</span><br><span class="line">        <span class="keyword">return</span> fileInfo;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
                
            </div>
        </article>
    
        <article class="post article-entry">
            <div class="post-title">
                <a class="post-title-link text-underline" href="/2024/01/19/401/">高并发系统设计</a>
            </div>
            <p class="sub">Jan 19 2024</p>
            <div class="post-content">
                
                    <h3 id="如何理解高并发系统"><a href="#如何理解高并发系统" class="headerlink" title="如何理解高并发系统"></a>如何理解高并发系统</h3><p>所谓设计高并发系统，就是设计一个系统，保证它整体可用的同时，能够处理很高的并发用户请求，能够承受很大的流量冲击。</p>
<h3 id="1-分而治之，横向扩展"><a href="#1-分而治之，横向扩展" class="headerlink" title="1. 分而治之，横向扩展"></a>1. 分而治之，横向扩展</h3><p>如果你只部署一个应用，只部署一台服务器，那抗住的流量请求是非常有限的。并且，单体的应用，有单点的风险，如果它挂了，那服务就不可用了。<br>因此，设计一个高并发系统，我们可以分而治之，横向扩展。也就是说，采用分布式部署的方式，部署多台服务器，把流量分流开，让每个服务器都承担一部分的并发和流量，提升整体系统的并发能力。</p>
<h3 id="2-微服务拆分（系统拆分）"><a href="#2-微服务拆分（系统拆分）" class="headerlink" title="2. 微服务拆分（系统拆分）"></a>2. 微服务拆分（系统拆分）</h3><p>要提高系统的吞吐，提高系统的处理并发请求的能力。除了采用分布式部署的方式外，还可以做微服务拆分，这样就可以达到分摊请求流量的目的，提高了并发能力。<br>所谓的微服务拆分，其实就是把一个单体的应用，按功能单一性，拆分为多个服务模块。比如一个电商系统，拆分为用户系统、订单系统、商品系统等等。</p>
<h3 id="3-分库分表"><a href="#3-分库分表" class="headerlink" title="3. 分库分表"></a>3. 分库分表</h3><p>当业务量暴增的话，MySQL单机磁盘容量会撑爆。并且，我们知道数据库连接数是有限的。在高并发的场景下，大量请求访问数据库，MySQL单机是扛不住的！高并发场景下，会出现too many connections报错。<br>所以高并发的系统，需要考虑拆分为多个数据库，来抗住高并发的毒打。而假如你的单表数据量非常大，存储和查询的性能就会遇到瓶颈了，如果你做了很多优化之后还是无法提升效率的时候，就需要考虑做分表了。一般千万级别数据量，就需要分表，每个表的数据量少一点，提升SQL查询性能。</p>
<h3 id="4-池化技术"><a href="#4-池化技术" class="headerlink" title="4. 池化技术"></a>4. 池化技术</h3><p>在高并发的场景下，数据库连接数可能成为瓶颈，因为连接数是有限的。<br>我们的请求调用数据库时，都会先获取数据库的连接，然后依靠这个连接来查询数据，搞完收工，最后关闭连接，释放资源。如果我们不用数据库连接池的话，每次执行SQL，都要创建连接和销毁连接，这就会导致每个查询请求都变得更慢了，相应的，系统处理用户请求的能力就降低了。<br>因此，需要使用池化技术，即数据库连接池、HTTP 连接池、Redis 连接池等等。使用数据库连接池，可以避免每次查询都新建连接，减少不必要的资源开销，通过复用连接池，提高系统处理高并发请求的能力。<br>同理，我们使用线程池，也能让任务并行处理，更高效地完成任务。大家可以看下我之前线程池的这篇文章，到时候面试官问到这块时，刚好可以扩展开来讲</p>
<h3 id="5-主从分离"><a href="#5-主从分离" class="headerlink" title="5. 主从分离"></a>5. 主从分离</h3><p>通常来说，一台单机的MySQL服务器，可以支持500左右的TPS和10000左右的QPS，即单机支撑的请求访问是有限的。因此你做了分布式部署，部署了多台机器，部署了主数据库、从数据库。<br>但是，如果双十一搞活动，流量肯定会猛增的。如果所有的查询请求，都走主库的话，主库肯定扛不住，因为查询请求量是非常非常大的。因此一般都要求做主从分离，然后实时性要求不高的读请求，都去读从库，写的请求或者实时性要求高的请求，才走主库。这样就很好保护了主库，也提高了系统的吞吐。</p>
<h3 id="6-使用缓存"><a href="#6-使用缓存" class="headerlink" title="6. 使用缓存"></a>6. 使用缓存</h3><p>无论是操作系统，浏览器，还是一些复杂的中间件，你都可以看到缓存的影子。我们使用缓存，主要是提升系统接口的性能，这样高并发场景，你的系统就可以支持更多的用户同时访问。<br>常用的缓存包括：Redis缓存，JVM本地缓存，memcached等等。就拿Redis来说，它单机就能轻轻松松应对几万的并发，你读场景的业务，可以用缓存来抗高并发。</p>
<h3 id="7-CDN，加速静态资源访问"><a href="#7-CDN，加速静态资源访问" class="headerlink" title="7. CDN，加速静态资源访问"></a>7. CDN，加速静态资源访问</h3><p>商品图片，icon等等静态资源，可以对页面做静态化处理，减少访问服务端的请求。如果用户分布在全国各地，有的在上海，有的在深圳，地域相差很远，网速也各不相同。为了让用户最快访问到页面，可以使用CDN。CDN可以让用户就近获取所需内容。</p>
<p>什么是CDN？<br>Content Delivery Network&#x2F;Content Distribution Network,翻译过来就是内容分发网络，它表示将静态资源分发到位于多个地理位置机房的服务器，可以做到数据就近访问，加速了静态资源的访问速度，因此让系统更好处理正常别的动态请求。</p>
<h3 id="8-消息队列，削锋"><a href="#8-消息队列，削锋" class="headerlink" title="8. 消息队列，削锋"></a>8. 消息队列，削锋</h3><p>我们搞一些双十一、双十二等运营活动时，需要避免流量暴涨，打垮应用系统的风险。因此一般会引入消息队列，来应对高并发的场景。</p>
<p>假设你的应用系统每秒最多可以处理2k个请求，每秒却有5k的请求过来，可以引入消息队列，应用系统每秒从消息队列拉2k请求处理得了。</p>
<h3 id="9-ElasticSearch"><a href="#9-ElasticSearch" class="headerlink" title="9. ElasticSearch"></a>9. ElasticSearch</h3><p>Elasticsearch，大家都使用得比较多了吧，一般搜索功能都会用到它。它是一个分布式、高扩展、高实时的搜索与数据分析引擎，简称为ES。<br>我们在聊高并发，为啥聊到ES呢？因为ES可以扩容方便，天然支撑高并发。当数据量大的时候，不用动不动就加机器扩容，分库等等，可以考虑用ES来支持简单的查询搜索、统计类的操作。</p>
<h3 id="10-降级熔断"><a href="#10-降级熔断" class="headerlink" title="10. 降级熔断"></a>10. 降级熔断</h3><p>熔断降级是保护系统的一种手段。当前互联网系统一般都是分布式部署的。而分布式系统中偶尔会出现某个基础服务不可用，最终导致整个系统不可用的情况, 这种现象被称为服务雪崩效应。<br>为了应对服务雪崩, 常见的做法是熔断和降级。最简单是加开关控制，当下游系统出问题时，开关打开降级，不再调用下游系统。还可以选用开源组件Hystrix来支持。<br>你要保证设计的系统能应对高并发场景，那肯定要考虑熔断降级逻辑进来。</p>
<h3 id="11-限流"><a href="#11-限流" class="headerlink" title="11.  限流"></a>11.  限流</h3><p>限流也是我们应对高并发的一种方案。我们当然希望，在高并发大流量过来时，系统能全部请求都正常处理。但是有时候没办法，系统的CPU、网络带宽、内存、线程等资源都是有限的。因此，我们要考虑限流。<br>如果你的系统每秒扛住的请求是一千，如果一秒钟来了十万请求呢？换个角度就是说，高并发的时候，流量洪峰来了，超过系统的承载能力，怎么办呢？<br>这时候，我们可以采取限流方案。就是为了保护系统，多余的请求，直接丢弃。<br>什么是限流：在计算机网络中，限流就是控制网络接口发送或接收请求的速率，它可防止DoS攻击和限制Web爬虫。限流，也称流量控制。是指系统在面临高并发，或者大流量请求的情况下，限制新的请求对系统的访问，从而保证系统的稳定性。<br>可以使用Guava的RateLimiter单机版限流，也可以使用Redis分布式限流，还可以使用阿里开源组件sentinel限流。<br>面试的时候，你说到限流这块的话？面试官很大概率会问你限流的算法，因此，大家在准备面试的时候，需要复习一下这几种经典的限流算法哈，可以看下我之前的这篇文章，面试必备：4种经典限流算法讲解</p>
<h3 id="12-异步"><a href="#12-异步" class="headerlink" title="12. 异步"></a>12. 异步</h3><p>回忆一下什么是同步，什么是异步呢？以方法调用为例，它代表调用方要阻塞等待被调用方法中的逻辑执行完成。这种方式下，当被调用方法响应时间较长时，会造成调用方长久的阻塞，在高并发下会造成整体系统性能下降甚至发生雪崩。异步调用恰恰相反，调用方不需要等待方法逻辑执行完成就可以返回执行其他的逻辑，在被调用方法执行完毕后再通过回调、事件通知等方式将结果反馈给调用方。<br>因此，设计一个高并发的系统，需要在恰当的场景使用异步。如何使用异步呢？后端可以借用消息队列实现。比如在海量秒杀请求过来时，先放到消息队列中，快速响应用户，告诉用户请求正在处理中，这样就可以释放资源来处理更多的请求。秒杀请求处理完后，通知用户秒杀抢购成功或者失败。</p>
<h3 id="13-接口的常规优化"><a href="#13-接口的常规优化" class="headerlink" title="13. 接口的常规优化"></a>13. 接口的常规优化</h3><p>设计一个高并发的系统，需要设计接口的性能足够好，这样系统在相同时间，就可以处理更多的请求。</p>
<h3 id="14-压力测试确定系统瓶颈"><a href="#14-压力测试确定系统瓶颈" class="headerlink" title="14. 压力测试确定系统瓶颈"></a>14. 压力测试确定系统瓶颈</h3><p>设计高并发系统，离不开最重要的一环，就是压力测试。就是在系统上线前，需要对系统进行压力测试，测清楚你的系统支撑的最大并发是多少，确定系统的瓶颈点，让自己心里有底，最好预防措施。<br>压测完要分析整个调用链路，性能可能出现问题是网络层（如带宽）、Nginx层、服务层、还是数据路缓存等中间件等等。<br><code>loadrunner</code>是一款不错的压力测试工具，jmeter则是接口性能测试工具，都可以来做下压测。</p>
<h3 id="15-应对突发流量峰值：扩容-切流量"><a href="#15-应对突发流量峰值：扩容-切流量" class="headerlink" title="15. 应对突发流量峰值：扩容+切流量"></a>15. 应对突发流量峰值：扩容+切流量</h3><p>如果是突发的流量高峰，除了降级、限流保证系统不跨，我们可以采用这两种方案，保证系统尽可能服务用户请求：<br>扩容：比如增加从库、提升配置的方式，提升系统&#x2F;组件的流量承载能力。比如增加MySQL、Redis从库来处理查询请求。<br>切流量：服务多机房部署，如果高并发流量来了，把流量从一个机房切换到另一个机房。</p>

                
            </div>
        </article>
    
</div>
<div class="side-bar">


    <div class="avator" id="avator">
    <div class="title">
        <a href="#" class="text-underline">About Me</a>
    </div>
        <img src="avator.jpg" class="ava-img">
        <h3 class="author">shang wj</h3>
        <div class="icon-list">
        <a href="yourweibo"><i class="iconfont icon-weibo icon-item"></i></a>
        <a href="mailto:youremail"><i class="iconfont icon-email icon-item"></i></a>
        <a href="yourgithub"><i class="iconfont icon-github icon-item"></i></a>
        <a href="yourlinkedin"><i class="iconfont icon-linkedin icon-item"></i></a>
        </div>
    <div class="tags">
    <h3 class="tags-title">Tags</h3>
    <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%BF%83%E6%83%85/" rel="tag">心情</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%9F%A5%E8%AF%86%E7%82%B9/" rel="tag">知识点</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/enable/" rel="tag">enable</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/systemctl/" rel="tag">systemctl</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%BC%80%E6%9C%BA/" rel="tag">开机</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/php-fpm/" rel="tag">php-fpm</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/php/" rel="tag">php</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%95%B0%E6%8D%AE%E5%BA%93/" rel="tag">数据库</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/obj/" rel="tag">obj</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/str/" rel="tag">str</a><span class="tag-list-count">1</span></li></ul>
</div>
    </div>
</div>

</section>

    <nav class="page-nav">
    
    
        <a class="next" href="/page/2/">
            <span class="next-text">Next</span>
            <i class="iconfont icon-right"></i>
        </a>
    
    </nav>



            </main>
            <div class="copyright">
  <div class="text">Powered By
    <a target="_blank" rel="noopener" href="https://hexo.io/">Hexo</a> | Theme <a target="_blank" rel="noopener" href="https://github.com/zjx137/hexo-theme-Tsu">Tsu</a> &copy 2019
  </div>
</div>

        </div>
    <div class="back-to-top" id="back-to-top">
            <i class="iconfont icon-up"></i>
    </div>
        
    </body>
    
<script src="/js/jquery-3.3.1.min.js"></script>

    
<script src="/js/back-to-top.js"></script>

    
<script src="/js/scroll.js"></script>

    <!-- MathJax配置，可通过单美元符号书写行内公式等 -->
<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
    "HTML-CSS": { 
        preferredFont: "TeX", 
        availableFonts: ["STIX","TeX"], 
        linebreaks: { automatic:true }, 
        EqnChunk: (MathJax.Hub.Browser.isMobile ? 10 : 50) 
    },
    tex2jax: { 
        inlineMath: [ ["$", "$"], ["\\(","\\)"] ], 
        processEscapes: true, 
        ignoreClass: "tex2jax_ignore|dno",
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    },
    TeX: {  
        equationNumbers: { autoNumber: "AMS" },
        noUndefined: { attributes: { mathcolor: "red", mathbackground: "#FFEEEE", mathsize: "90%" } }, 
        Macros: { href: "{}" } 
    },
    messageStyle: "none"
    }); 
</script>
<!-- 给MathJax元素添加has-jax class -->
<script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for(i=0; i < all.length; i += 1) {
            all[i].SourceElement().parentNode.className += ' has-jax';
        }
    });
</script>
<!-- 通过连接CDN加载MathJax的js代码 -->
<script type="text/javascript" async
  src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-MML-AM_CHTML">
</script>

</html>
