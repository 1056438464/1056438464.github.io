<!DOCTYPE html>
<html>
    <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">


<title>shang wj</title>


<link rel="stylesheet" href="/styles/main.css">


    <meta name="generator" content="Hexo 7.3.0"></head>
    <body>
        <div class="container">
            <header>
<div class="main">
<div class="title">
    <a href="#" class="logo">shang wj</a>
</div>
<div class="site-nav">
    <ul id="menu" class="menu">
    
        <li class="menu-item text-underline">
            <a href="/">Home</a>
        </li>
    
        <li class="menu-item text-underline">
            <a href="/archives">Archives</a>
        </li>
    
        <li class="menu-item text-underline">
            <a href="/about/">About</a>
        </li>
            
    </ul>
</div>
</div>
</header>
            <main class="main">
                <section class="posts clearfix">
    <div class="posts-wrapper">
    
        <article class="post article-entry">
            <div class="post-title">
                <a class="post-title-link text-underline" href="/2023/01/21/389/">InnoDB解决幻读的方案--LBCC&amp;MVCC</a>
            </div>
            <p class="sub">Jan 21 2023</p>
            <div class="post-content">
                
                    <h3 id="LBCC-MVCC"><a href="#LBCC-MVCC" class="headerlink" title="LBCC&amp;MVCC"></a>LBCC&amp;MVCC</h3><p>InnoDB默认的事务隔离级别是repeatable read（后文中用简称RR），它为了解决该隔离级别下的幻读的并发问题，提出了LBCC和MVCC两种方案。其中LBCC解决的是当前读情况下的幻读，MVCC解决的是普通读（快照读）的幻读。至于什么是当前读，什么是快照读，将在下文中给出答案。</p>
<h4 id="LBCC"><a href="#LBCC" class="headerlink" title="LBCC"></a>LBCC</h4><p>LBCC是Lock-Based Concurrent Control的简称，意思是基于锁的并发控制。在InnoDB中按锁的模式来分的话可以分为共享锁（S）、排它锁（X）和意向锁，其中意向锁又分为意向共享锁（IS）和意向排它锁（IX）（此处先不做介绍，后期会专门出篇文章讲一下InnoDB和Myisam引擎的锁）；如果按照锁的算法来分的话又分为记录锁（Record Locks）、间隙锁（Gap Locks）和临键锁（Next-key Locks）。其中临键锁就可以用来解决RR下的幻读问题</p>
<p>InnoDB 使用了两种技术来解决数据库中的幻读（phantom read）问题，即锁定读一致性控制（Lock-Based Concurrency Control, LBCC）和多版本并发控制（Multi-Version Concurrency Control, MVCC）。</p>
<h2 id="1-LBCC-Lock-Based-Concurrency-Control"><a href="#1-LBCC-Lock-Based-Concurrency-Control" class="headerlink" title="1. LBCC (Lock-Based Concurrency Control)"></a>1. LBCC (Lock-Based Concurrency Control)</h2><p>LBCC 主要依赖锁机制来管理并发事务的隔离性。在 InnoDB 中，幻读通过 <strong>间隙锁（Gap Lock）</strong> 和 <strong>下一键锁（Next-Key Lock）</strong> 来控制。这些锁可以防止其他事务在当前事务扫描范围内插入新的数据行，进而避免幻读现象：</p>
<ul>
<li><p><strong>间隙锁（Gap Lock）：</strong> 锁住一个范围之间的间隙，而不是实际的行。假设事务 A 查询范围 <code>5 &lt; id &lt; 10</code>，间隙锁会锁住这个范围，防止其他事务在此范围内插入新行。</p>
</li>
<li><p><strong>下一键锁（Next-Key Lock）：</strong> 是记录锁和间隙锁的组合，锁住了特定行及其前后的间隙。这样可以更好地控制读操作范围内的插入，确保事务的隔离性。</p>
</li>
</ul>
<p>在 <strong>可重复读（REPEATABLE READ）</strong> 隔离级别下，InnoDB 默认采用了下一键锁来处理幻读问题。通过这种锁机制，InnoDB 保证了在事务范围内的数据一致性。</p>
<h2 id="2-MVCC-Multi-Version-Concurrency-Control"><a href="#2-MVCC-Multi-Version-Concurrency-Control" class="headerlink" title="2. MVCC (Multi-Version Concurrency Control)"></a>2. MVCC (Multi-Version Concurrency Control)</h2><p>MVCC 通过在不同的事务中维护数据的多个版本来处理并发读写。每个事务访问数据时，会读取与自己一致的版本，避免了对其他事务的干扰。</p>
<p>MVCC 使用 <strong>隐藏的版本号和事务 ID</strong> 来区分不同版本的数据：</p>
<ul>
<li><p><strong>版本链：</strong> 数据行中包含一个指向旧版本的指针，形成一个版本链。当数据更新时，InnoDB 不会立即覆盖数据，而是创建一个新的版本。</p>
</li>
<li><p><strong>事务快照：</strong> 在启动时，事务会拍下一个快照，并使用该快照访问数据。这一机制让事务能够看到在其启动前的数据状态，即使后续有其他事务更改了数据。</p>
</li>
</ul>
<p>在 <strong>读提交（READ COMMITTED）</strong> 和 <strong>可重复读（REPEATABLE READ）</strong> 隔离级别下，MVCC 会帮助解决幻读问题，因为它让事务能够始终看到自己开始时的一致性视图。</p>
<h2 id="LBCC-vs-MVCC-应用场景"><a href="#LBCC-vs-MVCC-应用场景" class="headerlink" title="LBCC vs. MVCC 应用场景"></a>LBCC vs. MVCC 应用场景</h2><ul>
<li><p><strong>LBCC</strong> 更适合需要严格控制并发性和避免插入、更新导致的冲突的场景，如 <strong>可重复读隔离级别</strong>。</p>
</li>
<li><p><strong>MVCC</strong> 更适合高并发场景下的读操作，它让事务看到历史快照，有效减少锁竞争，提升读写性能。</p>
</li>
</ul>

                
            </div>
        </article>
    
        <article class="post article-entry">
            <div class="post-title">
                <a class="post-title-link text-underline" href="/2023/01/21/390/">面试必备常见存储引擎与锁的分类</a>
            </div>
            <p class="sub">Jan 21 2023</p>
            <div class="post-content">
                
                    <h1 id="常见存储引擎与锁的分类"><a href="#常见存储引擎与锁的分类" class="headerlink" title="常见存储引擎与锁的分类"></a>常见存储引擎与锁的分类</h1><p>在 MySQL 中，不同的存储引擎具有不同的锁机制。以下是几种常见存储引擎及其锁的分类。</p>
<h2 id="1-MyISAM-引擎"><a href="#1-MyISAM-引擎" class="headerlink" title="1. MyISAM 引擎"></a>1. MyISAM 引擎</h2><ul>
<li><strong>锁类型：表锁</strong><ul>
<li>MyISAM 使用<strong>表级锁（Table Lock）</strong>，即对整个表加锁。</li>
<li>每次查询需要先对表加锁，再进行读写操作，锁的粒度较大。</li>
<li>优点：锁管理简单，适用于读多写少的场景。</li>
<li>缺点：并发性能差，当写操作频繁时，其他读写操作都会被阻塞。</li>
</ul>
</li>
</ul>
<h2 id="2-InnoDB-引擎"><a href="#2-InnoDB-引擎" class="headerlink" title="2. InnoDB 引擎"></a>2. InnoDB 引擎</h2><ul>
<li><p><strong>锁类型：行锁 &amp; 表锁</strong></p>
<ul>
<li>InnoDB 支持<strong>行级锁（Row Lock）</strong>，即对记录级别进行加锁，锁的粒度更小。</li>
<li>InnoDB 还支持表锁，但通常使用行锁来实现更高的并发性。</li>
</ul>
</li>
<li><p><strong>锁实现：</strong></p>
<ul>
<li><strong>共享锁（S 锁）：</strong> 允许多个事务对同一行读取。</li>
<li><strong>排他锁（X 锁）：</strong> 一个事务获得排他锁后，其他事务无法对该行进行操作。</li>
<li><strong>间隙锁（Gap Lock）：</strong> 锁住一个范围之间的间隙，防止其他事务在此范围内插入数据。</li>
<li><strong>下一键锁（Next-Key Lock）：</strong> 结合行锁和间隙锁，锁住一行及其前后的间隙，用于防止幻读。</li>
</ul>
</li>
<li><p><strong>应用场景：</strong> 适用于事务性应用，保证更高的并发性和数据一致性。</p>
</li>
</ul>
<h2 id="3-Memory-引擎"><a href="#3-Memory-引擎" class="headerlink" title="3. Memory 引擎"></a>3. Memory 引擎</h2><ul>
<li><strong>锁类型：表锁</strong><ul>
<li>Memory 存储引擎使用表锁，即每次查询会锁住整个表。</li>
<li>Memory 表将数据存储在内存中，访问速度非常快，但一旦数据库重启，数据将丢失。</li>
<li><strong>应用场景：</strong> 常用于临时表或会话数据的缓存，不适合长时间保存数据的应用场景。</li>
</ul>
</li>
</ul>
<h2 id="4-NDB-Cluster-引擎"><a href="#4-NDB-Cluster-引擎" class="headerlink" title="4. NDB Cluster 引擎"></a>4. NDB Cluster 引擎</h2><ul>
<li><strong>锁类型：行锁</strong><ul>
<li>NDB Cluster 是一种分布式存储引擎，主要用于 MySQL Cluster 集群。</li>
<li>NDB Cluster 支持行级锁，锁的粒度较小，可以适应高并发应用。</li>
<li><strong>应用场景：</strong> 用于分布式系统和高可用场景，适合数据分片和水平扩展。</li>
</ul>
</li>
</ul>
<h2 id="锁的分类总结"><a href="#锁的分类总结" class="headerlink" title="锁的分类总结"></a>锁的分类总结</h2><table>
<thead>
<tr>
<th>锁类型</th>
<th>描述</th>
<th>适用引擎</th>
</tr>
</thead>
<tbody><tr>
<td>表锁（Table Lock）</td>
<td>锁住整个表，锁粒度大，适合读多写少的应用</td>
<td>MyISAM、Memory</td>
</tr>
<tr>
<td>行锁（Row Lock）</td>
<td>锁住特定行，锁粒度小，适合高并发</td>
<td>InnoDB、NDB Cluster</td>
</tr>
<tr>
<td>间隙锁（Gap Lock）</td>
<td>锁住行之间的间隙，防止插入，避免幻读</td>
<td>InnoDB</td>
</tr>
<tr>
<td>下一键锁（Next-Key Lock）</td>
<td>行锁与间隙锁结合，避免幻读问题</td>
<td>InnoDB</td>
</tr>
</tbody></table>

                
            </div>
        </article>
    
        <article class="post article-entry">
            <div class="post-title">
                <a class="post-title-link text-underline" href="/2022/12/21/388/">PageHelper</a>
            </div>
            <p class="sub">Dec 21 2022</p>
            <div class="post-content">
                
                    <p>pom.xml中引入依赖</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;com.github.pagehelper&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;pagehelper-spring-boot-starter&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;1.3.0&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure>
<p>application.yml中引入配置</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">pagehelper:</span></span><br><span class="line">  <span class="attr">helperDialect:</span> <span class="string">mysql</span></span><br><span class="line">  <span class="attr">reasonable:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">supportMethodsArguments:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">params:</span> <span class="string">count=countSql</span></span><br></pre></td></tr></table></figure>
<p>参数解释</p>
<p>1.helperDialect ：分页插件会自动检测当前的数据库链接，自动选择合适的分页方式。 你可以配置 helperDialect 属性来指定分页插件使用哪种方言。配置时，可以使用下面的缩写值：oracle , mysql , mariadb , sqlite , hsqldb , postgresql , db2 , sqlserver , informix , h2 , sqlserver2012 , derby</p>
<p>特别注意：使用 SqlServer2012 数据库时，需要手动指定为 sqlserver2012，否则会使用 SqlServer2005 的方式进行分页。你也可以实现 AbstractHelperDialect ，然后配置该属性为实现类的全限定名称即可使用自定义的实现方法。</p>
<ol>
<li><p>reasonable ：分页合理化参数，默认值为 false 。当该参数设置为 true 时， pageNum&lt;&#x3D;0 时会查询第一页， pageNum&gt;pages （超过总数时），会查询最后一页。默认 false 时，直接根据参数进行查询。</p>
<p> 3.supportMethodsArguments ：支持通过 Mapper 接口参数来传递分页参数，默认值 false ，分页插件会从查询方法的参数值中，自动根据上面 params 配置的字段中取值，查找到合适的值时就会自动分页。<br> 4.params ：为了支持 startPage(Object params)方法，增加了该参数来配置参数映射，用于从对象中根据属性名取值， 可以配置 pageNum,pageSize,count,pageSizeZero,reasonable ，不配置映射的用默认值， 默认值为 pageNum&#x3D;pageNum;pageSize&#x3D;pageSize;count&#x3D;countSql;reasonable&#x3D;reasonable;pageSizeZero&#x3D; pageSizeZero 。</p>
</li>
</ol>
<p>其他参数</p>
<p>•offsetAsPageNum ：默认值为 false ，该参数对使用 RowBounds 作为分页参数时有效。当该参数设置为 true 时，会将 RowBounds 中的 offset 参数当成 pageNum 使用，可以用页码和页面大小两个参数进行分页。<br>•rowBoundsWithCount ：默认值为 false，该参数对使用 RowBounds 作为分页参数时有效。当该参数设置为 true 时，使用 RowBounds 分页会进行 count 查询。<br>•pageSizeZero ：默认值为 false ，当该参数设置为 true 时，如果 pageSize&#x3D;0 或者 RowBounds.limit &#x3D; 0 就会查询出全部的结果（相当于没有执行分页查询，但是返回结果仍然是 Page 类型）。<br>•autoRuntimeDialect ：默认值为 false 。设置为 true 时，允许在运行时根据多数据源自动识别对应方言的分页 （不支持自动选择 sqlserver2012 ，只能使用 sqlserver ）<br>•closeConn ：默认值为 true 。当使用运行时动态数据源或没有设置 helperDialect 属性自动获取数据库类型时，会自动获取一个数据库连接， 通过该属性来设置是否关闭获取的这个连接，默认 true 关闭，设置为 false 后，不会关闭获取的连接，这个参数的设置要根据自己选择的数据源来决定。</p>
<p>使用方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PostMapping(&quot;/list&quot;)</span></span><br><span class="line"><span class="keyword">public</span> PageInfo&lt;ProductInfo&gt; <span class="title function_">list</span><span class="params">(<span class="meta">@RequestBody</span> BasePage basePage)</span>&#123;</span><br><span class="line">    PageHelper.startPage(basePage.getPageNum(),basePage.getPageSize());</span><br><span class="line">    List&lt;ProductInfo&gt; list = productInfoService.list(Wrappers.emptyWrapper());</span><br><span class="line">    PageInfo&lt;ProductInfo&gt; productInfoPageInfo = <span class="keyword">new</span> <span class="title class_">PageInfo</span>&lt;&gt;(list);</span><br><span class="line">    <span class="keyword">return</span> productInfoPageInfo;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>返回结果</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;total&quot;</span><span class="punctuation">:</span> <span class="number">3</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;list&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;从你的全世界路过&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;price&quot;</span><span class="punctuation">:</span> <span class="number">32.0000</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;createDate&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2020-11-21T21:26:12&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;updateDate&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2021-03-27T22:17:39&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;乔布斯传&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;price&quot;</span><span class="punctuation">:</span> <span class="number">25.0000</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;createDate&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2020-11-21T21:26:42&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;updateDate&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2021-03-27T22:17:42&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;pageNum&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;pageSize&quot;</span><span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;size&quot;</span><span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;startRow&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;endRow&quot;</span><span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;pages&quot;</span><span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;prePage&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;nextPage&quot;</span><span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;isFirstPage&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;isLastPage&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;hasPreviousPage&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;hasNextPage&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;navigatePages&quot;</span><span class="punctuation">:</span> <span class="number">8</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;navigatepageNums&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">        <span class="number">2</span></span><br><span class="line">    <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;navigateFirstPage&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;navigateLastPage&quot;</span><span class="punctuation">:</span> <span class="number">2</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<h3 id="如何实现分页的"><a href="#如何实现分页的" class="headerlink" title="如何实现分页的"></a>如何实现分页的</h3><h4 id="一、先说一个小的知识点：ThreadLocal"><a href="#一、先说一个小的知识点：ThreadLocal" class="headerlink" title="一、先说一个小的知识点：ThreadLocal"></a>一、先说一个小的知识点：ThreadLocal</h4><p>ThreadLocal 是什么？有哪些使用场景？</p>
<p>ThreadLocal是Java提供的用来存储线程中局部变量的类，线程局部变量是局限于线程内部的变量，属于线程自身所有，不被多个线程间共享，通过get和set方法就可以得到当前线程对应的值。</p>
<p>Java提供ThreadLocal类来支持线程局部变量，是一种实现线程安全的方式。但是在管理环境下（如 web 服务器）使用线程局部变量的时候要特别小心，在这种情况下，工作线程的生命周期比任何应用变量的生命周期都要长。任何线程局部变量一旦在工作完成后没有释放，Java 应用就存在内存泄露的风险。</p>
<p>对比</p>
<p>•Synchronized是通过线程等待，牺牲时间来解决访问冲突<br>•ThreadLocal是通过每个线程单独一份存储空间，牺牲空间来解决冲突，并且相比于Synchronized，ThreadLocal具有线程隔离的效果，只有在线程内才能获取到对应的值，线程外则不能访问到想要的值。</p>
<h4 id="二、看一下ThreadLocal-在PageHelper中的应用（直接上代码）"><a href="#二、看一下ThreadLocal-在PageHelper中的应用（直接上代码）" class="headerlink" title="二、看一下ThreadLocal 在PageHelper中的应用（直接上代码）"></a>二、看一下ThreadLocal 在PageHelper中的应用（直接上代码）</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* 分页调用的最终方法</span></span><br><span class="line"><span class="comment">**/</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;E&gt; Page&lt;E&gt; <span class="title function_">startPage</span><span class="params">(<span class="type">int</span> pageNum, <span class="type">int</span> pageSize, <span class="type">boolean</span> count,</span></span><br><span class="line"><span class="params">                                    Boolean reasonable, Boolean pageSizeZero)</span> &#123;</span><br><span class="line">    Page&lt;E&gt; page = <span class="keyword">new</span> <span class="title class_">Page</span>&lt;E&gt;(pageNum, pageSize, count);</span><br><span class="line">    page.setReasonable(reasonable);</span><br><span class="line">    page.setPageSizeZero(pageSizeZero);</span><br><span class="line">    <span class="comment">//当已经执行过orderBy的时候</span></span><br><span class="line">    Page&lt;E&gt; oldPage = getLocalPage();</span><br><span class="line">    <span class="keyword">if</span> (oldPage != <span class="literal">null</span> &amp;&amp; oldPage.isOrderByOnly()) &#123;</span><br><span class="line">        page.setOrderBy(oldPage.getOrderBy());</span><br><span class="line">    &#125;</span><br><span class="line">    setLocalPage(page);</span><br><span class="line">    <span class="keyword">return</span> page;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//里边最重要的就是Page&lt;E&gt; oldPage = getLocalPage();和setLocalPage(page);方法，他俩是看当前线程中的</span></span><br><span class="line"><span class="comment">//ThreadLocal.ThreadLocalMap中是否存在该page对象，若存在直接取出，若不存在则设置一个，我们以第一个为例继续深入</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">static</span> <span class="keyword">final</span> ThreadLocal&lt;Page&gt; LOCAL_PAGE = <span class="keyword">new</span> <span class="title class_">ThreadLocal</span>&lt;Page&gt;();</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 获取 Page 参数</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; Page&lt;T&gt; <span class="title function_">getLocalPage</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> LOCAL_PAGE.get();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> T <span class="title function_">get</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">//获取当前线程</span></span><br><span class="line">    <span class="type">Thread</span> <span class="variable">t</span> <span class="operator">=</span> Thread.currentThread();</span><br><span class="line">    <span class="comment">//获取当前线程中的ThreadLocalMap</span></span><br><span class="line">    <span class="type">ThreadLocalMap</span> <span class="variable">map</span> <span class="operator">=</span> getMap(t);<span class="comment">//ThreadLocal.ThreadLocalMap threadLocals = null;</span></span><br><span class="line">    <span class="keyword">if</span> (map != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">//getEntry(ThreadLocal&lt;?&gt; key)源码在下边</span></span><br><span class="line">        ThreadLocalMap.<span class="type">Entry</span> <span class="variable">e</span> <span class="operator">=</span> map.getEntry(<span class="built_in">this</span>);</span><br><span class="line">        <span class="keyword">if</span> (e != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line">            <span class="type">T</span> <span class="variable">result</span> <span class="operator">=</span> (T)e.value;</span><br><span class="line">            <span class="keyword">return</span> result;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> setInitialValue();<span class="comment">//=&gt; t.threadLocals = new ThreadLocalMap(this, firstValue);</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> Entry <span class="title function_">getEntry</span><span class="params">(ThreadLocal&lt;?&gt; key)</span> &#123;</span><br><span class="line">    <span class="comment">//通过hashCode与length位运算确定出一个索引值i，这个i就是被存储在table数组中的位置</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> key.threadLocalHashCode &amp; (table.length - <span class="number">1</span>);</span><br><span class="line">    <span class="type">Entry</span> <span class="variable">e</span> <span class="operator">=</span> table[i];</span><br><span class="line">    <span class="keyword">if</span> (e != <span class="literal">null</span> &amp;&amp; e.get() == key)</span><br><span class="line">        <span class="keyword">return</span> e;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="keyword">return</span> getEntryAfterMiss(key, i, e);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Entry</span> <span class="keyword">extends</span> <span class="title class_">WeakReference</span>&lt;ThreadLocal&lt;?&gt;&gt; &#123;</span><br><span class="line">    <span class="comment">/** The value associated with this ThreadLocal. */</span></span><br><span class="line">    Object value;</span><br><span class="line"></span><br><span class="line">    Entry(ThreadLocal&lt;?&gt; k, Object v) &#123;</span><br><span class="line">        <span class="built_in">super</span>(k);</span><br><span class="line">        value = v;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>总结： 我们发现在Thread中维护着类型为ThreadLocal.ThreadLocalMap的一个参数threadLocals，可以把它看作是一个特殊的map，它的key是threadLocal的threadLocalHashCode，value是我们设置的page信息，其实它底下维护了一个大小为16的环形的table数组，它的负载因子为2&#x2F;3，我们的数据就存在这个table中的Entry对象中。</p>
<h5 id="知识点："><a href="#知识点：" class="headerlink" title="知识点："></a>知识点：</h5><p>1、这里之所以设置为WeakReference，是因为如果这里使用普通的key-value形式来定义存储结构，实质上就会造成节点的生命周期与线程强绑定，只要线程没有销毁，那么节点在GC分析中一直处于可达状态，没办法被回收，而程序本身也无法判断是否可以清理节点。弱引用是Java中四档引用的第三档，比软引用更加弱一些，如果一个对象没有强引用链可达，那么一般活不过下一次GC。当某个ThreadLocal已经没有强引用可达，则随着它被垃圾回收，在ThreadLocalMap里对应的Entry的键值会失效，这为ThreadLocalMap本身的垃圾清理提供了便利。</p>
<p>2、对于某一ThreadLocal来讲，他的索引值i是确定的，在不同线程之间访问时访问的是不同的table数组的同一位置即都为table[i]，只不过这个不同线程之间的table是独立的。</p>
<p>3、对于同一线程的不同ThreadLocal来讲，这些ThreadLocal实例共享一个table数组，然后每个ThreadLocal实例在table中的索引i是不同的。</p>
<h4 id="三、PageHelper实际拦截SQL"><a href="#三、PageHelper实际拦截SQL" class="headerlink" title="三、PageHelper实际拦截SQL"></a>三、PageHelper实际拦截SQL</h4><p>一说到sql的拦截功能，大家应该会想到Mybatis的拦截器吧。Mybatis拦截器可以对下面4种对象进行拦截：</p>
<p>•Executor：mybatis的内部执行器，作为调度核心负责调用StatementHandler操作数据库，并把结果集通过ResultSetHandler进行自动映射<br>•StatementHandler：封装了JDBC Statement操作，是sql语法的构建器，负责和数据库进行交互执行sql语句<br>•ParameterHandler：作为处理sql参数设置的对象，主要实现读取参数和对PreparedStatement的参数进行赋值<br>•ResultSetHandler：处理Statement执行完成后返回结果集的接口对象，mybatis通过它把ResultSet集合映射成实体对象<br>PageHelper也是用的mybatis的拦截器进行分页的，接下来就让我们看下代码吧：首先进入<code>PageInterceptor</code> 拦截器</p>
<h5 id="关注关键代码"><a href="#关注关键代码" class="headerlink" title="关注关键代码"></a>关注关键代码</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Object <span class="title function_">intercept</span><span class="params">(Invocation invocation)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        ...</span><br><span class="line"></span><br><span class="line">        resultList = ExecutorUtil.pageQuery(dialect, executor,</span><br><span class="line">                                            ms, parameter, rowBounds, resultHandler, boundSql, cacheKey);</span><br><span class="line">        ...</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;E&gt; List&lt;E&gt; <span class="title function_">pageQuery</span><span class="params">(Dialect dialect, Executor executor, MappedStatement ms, Object parameter,RowBounds rowBounds, ResultHandler resultHandler,BoundSql boundSql, CacheKey cacheKey)</span> <span class="keyword">throws</span> SQLException &#123;</span><br><span class="line">        <span class="comment">//判断是否需要进行分页查询</span></span><br><span class="line">        <span class="keyword">if</span> (dialect.beforePage(ms, parameter, rowBounds)) &#123;</span><br><span class="line">            <span class="comment">//生成分页的缓存 key</span></span><br><span class="line">            <span class="type">CacheKey</span> <span class="variable">pageKey</span> <span class="operator">=</span> cacheKey;</span><br><span class="line">            <span class="comment">//处理参数对象</span></span><br><span class="line">            parameter = dialect.processParameterObject(ms, parameter, boundSql, pageKey);</span><br><span class="line">            ...</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line">获取到ThreadLocal中的page对象</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Object <span class="title function_">processParameterObject</span><span class="params">(MappedStatement ms, Object parameterObject, BoundSql boundSql, CacheKey pageKey)</span> &#123;</span><br><span class="line">     ...</span><br><span class="line">     <span class="keyword">return</span> processPageParameter(ms, paramMap, page, boundSql, pageKey);</span><br><span class="line">     &#125;</span><br></pre></td></tr></table></figure>
                
            </div>
        </article>
    
        <article class="post article-entry">
            <div class="post-title">
                <a class="post-title-link text-underline" href="/2022/12/19/387/">附近人功能实现</a>
            </div>
            <p class="sub">Dec 19 2022</p>
            <div class="post-content">
                
                    <p>redis自带的GEO来实现此功能。</p>
<p>一、</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">SET</span> NAMES utf8mb4;</span><br><span class="line"><span class="keyword">SET</span> FOREIGN_KEY_CHECKS <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="comment">-- Table structure for job_base_info</span></span><br><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> IF <span class="keyword">EXISTS</span> `job_base_info`;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `job_base_info`  (</span><br><span class="line">  `job_id` <span class="type">bigint</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT COMMENT <span class="string">&#x27;任务ID&#x27;</span>,</span><br><span class="line">  `job_name` <span class="type">varchar</span>(<span class="number">50</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8 <span class="keyword">COLLATE</span> utf8_general_ci <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;任务名称&#x27;</span>,</span><br><span class="line">  `job_location` <span class="type">varchar</span>(<span class="number">50</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8 <span class="keyword">COLLATE</span> utf8_general_ci <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;&#x27;</span> COMMENT <span class="string">&#x27;任务地点位置经纬度-逗号隔开&#x27;</span>,</span><br><span class="line">  `job_detail_address` <span class="type">varchar</span>(<span class="number">255</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8 <span class="keyword">COLLATE</span> utf8_general_ci <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;任务详细地点位置&#x27;</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`job_id`) <span class="keyword">USING</span> BTREE</span><br><span class="line">) ENGINE <span class="operator">=</span> InnoDB AUTO_INCREMENT <span class="operator">=</span> <span class="number">24</span> <span class="type">CHARACTER</span> <span class="keyword">SET</span> <span class="operator">=</span> utf8 <span class="keyword">COLLATE</span> <span class="operator">=</span> utf8_general_ci COMMENT <span class="operator">=</span> <span class="string">&#x27;工作任务详情基础信息表&#x27;</span> ROW_FORMAT <span class="operator">=</span> <span class="keyword">DYNAMIC</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="comment">-- Records of job_base_info</span></span><br><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `job_base_info` <span class="keyword">VALUES</span> (<span class="number">1</span>, <span class="string">&#x27;软件开发&#x27;</span>, <span class="string">&#x27;120.433576,36.139697&#x27;</span>, <span class="string">&#x27;青岛市崂山区海尔路1号&#x27;</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `job_base_info` <span class="keyword">VALUES</span> (<span class="number">2</span>, <span class="string">&#x27;儿童摄影&#x27;</span>, <span class="string">&#x27;120.420297,36.156589&#x27;</span>, <span class="string">&#x27;山东省青岛市李沧区书院路188号&#x27;</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `job_base_info` <span class="keyword">VALUES</span> (<span class="number">3</span>, <span class="string">&#x27;清洁家用电器&#x27;</span>, <span class="string">&#x27;120.025706,36.281478&#x27;</span>, <span class="string">&#x27;山东省青岛市胶州市福州支路232号东60米&#x27;</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `job_base_info` <span class="keyword">VALUES</span> (<span class="number">4</span>, <span class="string">&#x27;辩论学习&#x27;</span>, <span class="string">&#x27;120.505042,36.171247&#x27;</span>, <span class="string">&#x27;松岭路238号中国海洋大学内&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">SET</span> FOREIGN_KEY_CHECKS <span class="operator">=</span> <span class="number">1</span>;</span><br></pre></td></tr></table></figure>

<p>（1）程序启动时，将数据库中的任务数据的坐标信息初始化到redis中（此处暂且忽略任务的增删改查对redis中数据的影响）</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PostConstruct</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="comment">//首先要删除该key的所有值</span></span><br><span class="line">    redisTemplate.delete(<span class="string">&quot;company-task&quot;</span>);</span><br><span class="line">    List&lt;JobBaseInfo&gt; jobBaseInfoList = jobBaseInfoMapper.selectList(Wrappers.emptyWrapper());</span><br><span class="line">    jobBaseInfoList.stream().forEach(item-&gt;&#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">jobLocation</span> <span class="operator">=</span> item.getJobLocation();</span><br><span class="line">        <span class="keyword">if</span>(StrUtil.isNotEmpty(jobLocation))&#123;</span><br><span class="line">            String[] split = jobLocation.split(<span class="string">&quot;,&quot;</span>);comp</span><br><span class="line">            <span class="title function_">if</span><span class="params">(split.length==<span class="number">2</span>)</span>&#123;</span><br><span class="line">                <span class="comment">//Point(经度, 纬度) </span></span><br><span class="line">                <span class="type">Point</span> <span class="variable">point</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Point</span>(Double.parseDouble(split[<span class="number">0</span>]),Double.parseDouble(split[<span class="number">1</span>]));</span><br><span class="line">                <span class="comment">//将经纬度数据及其id存到key为“company-task”中</span></span><br><span class="line">                redisTemplate.opsForGeo().add(<span class="string">&quot;company-task&quot;</span>,point,item.getJobId());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>（2）查询当前坐标下3km范围内的任务地点（外加根据任务名搜索的联合查询）</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> List&lt;JobBaseInfo&gt; <span class="title function_">selectJobList</span><span class="params">(JobBaseInfoDTO jobBaseInfoDTO)</span> &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">jobLocation</span> <span class="operator">=</span> jobBaseInfoDTO.getJobLocation();</span><br><span class="line">    <span class="comment">//距离</span></span><br><span class="line">    <span class="type">Double</span> <span class="variable">distance</span> <span class="operator">=</span> jobBaseInfoDTO.getDistance();</span><br><span class="line">    List&lt;Integer&gt; idList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    <span class="keyword">if</span>(StringUtils.isNotNull(jobLocation) &amp;&amp; StringUtils.isNotNull(distance))&#123;</span><br><span class="line">        String[] split = jobLocation.split(<span class="string">&quot;,&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span>(split.length==<span class="number">2</span>)&#123;</span><br><span class="line">            <span class="comment">//Point(经度, 纬度) Distance(距离量, 距离单位)</span></span><br><span class="line">            <span class="type">Circle</span> <span class="variable">circle</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Circle</span>(<span class="keyword">new</span> <span class="title class_">Point</span>(Double.parseDouble(split[<span class="number">0</span>]),Double.parseDouble(split[<span class="number">1</span>])),</span><br><span class="line">                                       <span class="keyword">new</span> <span class="title class_">Distance</span>(distance, Metrics.KILOMETERS));</span><br><span class="line">            <span class="comment">//params: key, Circle 获取存储到redis中的distance范围内的所有任务地点数据</span></span><br><span class="line">            <span class="type">GeoResults</span> <span class="variable">radius</span> <span class="operator">=</span> redisTemplate.opsForGeo().radius(<span class="string">&quot;company-task&quot;</span>, circle);</span><br><span class="line">            List&lt;GeoResult&gt; contentList = radius.getContent();</span><br><span class="line">            <span class="keyword">if</span>(contentList.size()&gt;<span class="number">0</span>)&#123;</span><br><span class="line">                contentList.stream().forEach(item-&gt;&#123;</span><br><span class="line">                    RedisGeoCommands.<span class="type">GeoLocation</span> <span class="variable">content</span> <span class="operator">=</span> (RedisGeoCommands.GeoLocation) item.getContent();</span><br><span class="line">                    idList.add((Integer) content.getName());</span><br><span class="line">                &#125;);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    jobBaseInfoDTO.setIdList(idList);</span><br><span class="line">    <span class="keyword">return</span> jobBaseInfoMapper.selectJobList(jobBaseInfoDTO);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>selectJobList(jobBaseInfoDTO)方法的sql如下</p>
<pre><code class="xml">&lt;select id=&quot;selectJobList&quot; resultType=&quot;com.itzyq.redislikes.model.entity.JobBaseInfo&quot;&gt;
    select
    &lt;include refid=&quot;Base_Column_List&quot;&gt;&lt;/include&gt;
    from job_base_info
    &lt;where&gt;
        &lt;if test=&quot;jobName!=null and jobName!=&#39;&#39;&quot;&gt;
            and job_name like CONCAT(&quot;%&quot;,#&#123;jobName&#125;,&quot;%&quot;)
        &lt;/if&gt;

        &lt;if test=&quot;idList!=null and idList.size &gt; 0 &quot;&gt;
            and job_id in
            &lt;foreach collection=&quot;idList&quot; item=&quot;id&quot; open=&quot;(&quot; close=&quot;)&quot; separator=&quot;,&quot;&gt;
                #&#123;id&#125;
            &lt;/foreach&gt;
        &lt;/if&gt;
    &lt;/where&gt;
&lt;/select&gt;
</code></pre>
<h5 id="二、Redis中的GEO"><a href="#二、Redis中的GEO" class="headerlink" title="二、Redis中的GEO"></a>二、Redis中的GEO</h5><p>Redis GEO 主要用于存储地理位置信息，并对存储的信息进行操作，该功能在 Redis 3.2 版本新增，GEO 是基于zset的一种扩展数据格式。Redis GEO 操作方法有：<br>•geoadd：添加地理位置的坐标。<br>•geopos：获取地理位置的坐标。<br>•geodist：计算两个位置之间的距离。<br>•georadius：根据用户给定的经纬度坐标来获取指定范围内的地理位置集合。<br>•georadiusbymember：根据储存在位置集合里面的某个地点获取指定范围内的地理位置集合。<br>•geohash：返回一个或多个位置对象的 geohash 值。</p>

                
            </div>
        </article>
    
        <article class="post article-entry">
            <div class="post-title">
                <a class="post-title-link text-underline" href="/2022/11/23/386/">点赞功能demo实现</a>
            </div>
            <p class="sub">Nov 23 2022</p>
            <div class="post-content">
                
                    <p>设计思路大概分为两种：<br>一种自然是用MySQL等数据库直接落地存储， 另外一种就是将点赞的数据保存到Redis等缓存里，在一定时间后刷回MySQL等数据库。<br>以MySQL和Redis为例。</p>
<h3 id="1、直接写入数据库："><a href="#1、直接写入数据库：" class="headerlink" title="1、直接写入数据库："></a>1、直接写入数据库：</h3><p>优点：这种方法实现简单，只需完成数据库的增删改查就行；</p>
<p>缺点： 数据库读写压力大，如果遇到热门文章在短时间内被大量点赞的情况，直接操作数据库会给数据库带来巨大压力，影响效率。</p>
<h3 id="2、使用Redis缓存："><a href="#2、使用Redis缓存：" class="headerlink" title="2、使用Redis缓存："></a>2、使用Redis缓存：</h3><p>优点：性能高，读写速度快，缓解数据库读写的压力；</p>
<p>缺点： 开发复杂，不能保证数据安全性即redis挂掉的时候会丢失数据， 同时不及时同步redis中的数据， 可能会在redis内存置换的时候被淘汰掉。不过对于点赞数据我们不需要那么精确，丢失一点数据问题不大。</p>
<p>接下来就从以下三个方面对点赞功能做详细的介绍</p>
<p>• Redis 缓存设计<br>• 数据库设计<br>• 开启定时任务持久化存储到数据库</p>
<h4 id="1、Redis缓存设计及实现"><a href="#1、Redis缓存设计及实现" class="headerlink" title="1、Redis缓存设计及实现"></a>1、Redis缓存设计及实现</h4><p>Redis的整合我们在上一篇文章中已经介绍过了，此处就不再赘述了。我们了解到，我们在做点赞的时候需要记录以下几类数据：一类是某用户被其他用户点赞的详细记录，一类是。考虑到查询与存取方便快捷，我这边采用Hash结构进行存储，存储结构如下：</p>
<p>（1）某用户被其他用户点赞的详细记录：MAP_USER_LIKED为键值，被点赞用户id::点赞用户id为filed，1或者0为value</p>
<p>（2）某用户被点赞的数量统计：MAP_USER_LIKED_COUNT为键值，被点赞用户id为filed，count为value</p>
<p>部分代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* 将用户被其他用户点赞的数据存到redis</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">saveLiked2Redis</span><span class="params">(String likedUserId, String likedPostId)</span> &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> RedisKeyUtils.getLikedKey(likedUserId, likedPostId);</span><br><span class="line">    redisTemplate.opsForHash().put(RedisKeyUtils.MAP_KEY_USER_LIKED,key, LikedStatusEnum.LIKE.getCode());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//取消点赞</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">unlikeFromRedis</span><span class="params">(String likedUserId, String likedPostId)</span> &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> RedisKeyUtils.getLikedKey(likedUserId, likedPostId);</span><br><span class="line">    redisTemplate.opsForHash().put(RedisKeyUtils.MAP_KEY_USER_LIKED,key,LikedStatusEnum.UNLIKE.getCode());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* 将被点赞用户的数量+1</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">incrementLikedCount</span><span class="params">(String likedUserId)</span> &#123;</span><br><span class="line">    redisTemplate.opsForHash().increment(RedisKeyUtils.MAP_KEY_USER_LIKED_COUNT,likedUserId,<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//-1</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">decrementLikedCount</span><span class="params">(String likedUserId)</span> &#123;</span><br><span class="line">    redisTemplate.opsForHash().increment(RedisKeyUtils.MAP_KEY_USER_LIKED_COUNT, likedUserId, -<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* 获取Redis中的用户点赞详情记录</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> List&lt;UserLikeDetail&gt; <span class="title function_">getLikedDataFromRedis</span><span class="params">()</span> &#123;</span><br><span class="line">    Cursor&lt;Map.Entry&lt;Object,Object&gt;&gt; scan = redisTemplate.opsForHash().scan(RedisKeyUtils.MAP_KEY_USER_LIKED, ScanOptions.NONE);</span><br><span class="line">    List&lt;UserLikeDetail&gt; list = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    <span class="keyword">while</span> (scan.hasNext())&#123;</span><br><span class="line">        Map.Entry&lt;Object, Object&gt; entry = scan.next();</span><br><span class="line">        <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> (String) entry.getKey();</span><br><span class="line">        String[] split = key.split(<span class="string">&quot;::&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">likedUserId</span> <span class="operator">=</span> split[<span class="number">0</span>];</span><br><span class="line">        <span class="type">String</span> <span class="variable">likedPostId</span> <span class="operator">=</span> split[<span class="number">1</span>];</span><br><span class="line">        <span class="type">Integer</span> <span class="variable">value</span> <span class="operator">=</span> (Integer) entry.getValue();</span><br><span class="line">        <span class="comment">//组装成 UserLike 对象</span></span><br><span class="line">        <span class="type">UserLikeDetail</span> <span class="variable">userLikeDetail</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UserLikeDetail</span>(likedUserId, likedPostId, value);</span><br><span class="line">        list.add(userLikeDetail);</span><br><span class="line">        <span class="comment">//存到 list 后从 Redis 中删除</span></span><br><span class="line">        redisTemplate.opsForHash().delete(RedisKeyUtils.MAP_KEY_USER_LIKED, key);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> list;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* 获取Redis中的用户被点赞数量</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> List&lt;UserLikCountDTO&gt; <span class="title function_">getLikedCountFromRedis</span><span class="params">()</span> &#123;</span><br><span class="line">    Cursor&lt;Map.Entry&lt;Object,Object&gt;&gt; cursor = redisTemplate.opsForHash().scan(RedisKeyUtils.MAP_KEY_USER_LIKED_COUNT, ScanOptions.NONE);</span><br><span class="line">    List&lt;UserLikCountDTO&gt; list = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    <span class="keyword">while</span>(cursor.hasNext())&#123;</span><br><span class="line">        Map.Entry&lt;Object, Object&gt; map = cursor.next();</span><br><span class="line">        <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> (String) map.getKey();</span><br><span class="line">        <span class="type">Integer</span> <span class="variable">value</span> <span class="operator">=</span> (Integer) map.getValue();</span><br><span class="line">        <span class="type">UserLikCountDTO</span> <span class="variable">userLikCountDTO</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UserLikCountDTO</span>(key,value);</span><br><span class="line">        list.add(userLikCountDTO);</span><br><span class="line">        <span class="comment">//存到 list 后从 Redis 中删除</span></span><br><span class="line">        redisTemplate.opsForHash().delete(RedisKeyUtils.MAP_KEY_USER_LIKED_COUNT,key);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> list;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="2、数据库设计"><a href="#2、数据库设计" class="headerlink" title="2、数据库设计"></a>2、数据库设计</h4><p>这里我们可以和直接将点赞数据存到数据库一样，设计两张表：</p>
<p>(1)用户被其他用户点赞的详细记录:user_like_detail</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> IF <span class="keyword">EXISTS</span> `user_like_detail`;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `user_like_detail`  (</span><br><span class="line">  `id` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT,</span><br><span class="line">  `liked_user_id` <span class="type">varchar</span>(<span class="number">32</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8 <span class="keyword">COLLATE</span> utf8_general_ci <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;被点赞的用户id&#x27;</span>,</span><br><span class="line">  `liked_post_id` <span class="type">varchar</span>(<span class="number">32</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8 <span class="keyword">COLLATE</span> utf8_general_ci <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;点赞的用户id&#x27;</span>,</span><br><span class="line">  `status` tinyint(<span class="number">1</span>) <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="number">1</span> COMMENT <span class="string">&#x27;点赞状态，0取消，1点赞&#x27;</span>,</span><br><span class="line">  `create_time` <span class="type">timestamp</span>(<span class="number">0</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span>(<span class="number">0</span>) COMMENT <span class="string">&#x27;创建时间&#x27;</span>,</span><br><span class="line">  `update_time` <span class="type">timestamp</span>(<span class="number">0</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span>(<span class="number">0</span>) <span class="keyword">ON</span> <span class="keyword">UPDATE</span> <span class="built_in">CURRENT_TIMESTAMP</span>(<span class="number">0</span>) COMMENT <span class="string">&#x27;修改时间&#x27;</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`id`) <span class="keyword">USING</span> BTREE,</span><br><span class="line">  INDEX `liked_user_id`(`liked_user_id`) <span class="keyword">USING</span> BTREE,</span><br><span class="line">  INDEX `liked_post_id`(`liked_post_id`) <span class="keyword">USING</span> BTREE</span><br><span class="line">) ENGINE <span class="operator">=</span> InnoDB AUTO_INCREMENT <span class="operator">=</span> <span class="number">7</span> <span class="type">CHARACTER</span> <span class="keyword">SET</span> <span class="operator">=</span> utf8 <span class="keyword">COLLATE</span> <span class="operator">=</span> utf8_general_ci COMMENT <span class="operator">=</span> <span class="string">&#x27;用户点赞表&#x27;</span> ROW_FORMAT <span class="operator">=</span> <span class="keyword">Dynamic</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">SET</span> FOREIGN_KEY_CHECKS <span class="operator">=</span> <span class="number">1</span>;</span><br></pre></td></tr></table></figure>
<p>(2)用户被点赞的数量统计:user_like_count</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> IF <span class="keyword">EXISTS</span> `user_like_count`;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `user_like_count`  (</span><br><span class="line">  `id` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT,</span><br><span class="line">  `like_num` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="number">0</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`id`) <span class="keyword">USING</span> BTREE</span><br><span class="line">) ENGINE <span class="operator">=</span> InnoDB AUTO_INCREMENT <span class="operator">=</span> <span class="number">7</span> <span class="type">CHARACTER</span> <span class="keyword">SET</span> <span class="operator">=</span> utf8 <span class="keyword">COLLATE</span> <span class="operator">=</span> utf8_general_ci ROW_FORMAT <span class="operator">=</span> <span class="keyword">Dynamic</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">SET</span> FOREIGN_KEY_CHECKS <span class="operator">=</span> <span class="number">1</span>;</span><br></pre></td></tr></table></figure>
<p>3、开启定时任务持久化存储到数据库</p>
<p>我们使用Quartz来实现定时任务，将Redis中的数据存储到数据库中，为了演示效果，我们可以设置一分钟或者两分钟存储一遍数据，这个视具体业务而定。在同步数据的过程中，我们首先要将Redis中的数据在数据库中进行查重，舍弃重复数据，这样我们的数据才会更加准确。</p>
<p>部分代码如下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//同步redis的用户点赞数据到数据库</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">transLikedFromRedis2DB</span><span class="params">()</span> &#123;</span><br><span class="line">    List&lt;UserLikeDetail&gt; list = redisService.getLikedDataFromRedis();</span><br><span class="line">    list.stream().forEach(item-&gt;&#123;</span><br><span class="line">        <span class="comment">//查重</span></span><br><span class="line">        <span class="type">UserLikeDetail</span> <span class="variable">userLikeDetail</span> <span class="operator">=</span> userLikeDetailMapper.selectOne(<span class="keyword">new</span> <span class="title class_">LambdaQueryWrapper</span>&lt;UserLikeDetail&gt;()</span><br><span class="line">           .eq(UserLikeDetail::getLikedUserId, item.getLikedUserId())</span><br><span class="line">           .eq(UserLikeDetail::getLikedPostId, item.getLikedPostId()));</span><br><span class="line">        <span class="keyword">if</span> (userLikeDetail == <span class="literal">null</span>)&#123;</span><br><span class="line">            userLikeDetail = <span class="keyword">new</span> <span class="title class_">UserLikeDetail</span>();</span><br><span class="line">            BeanUtils.copyProperties(item, userLikeDetail);</span><br><span class="line">            <span class="comment">//没有记录，直接存入</span></span><br><span class="line">            userLikeDetail.setCreateTime(LocalDateTime.now());</span><br><span class="line">            userLikeDetailMapper.insert(userLikeDetail);</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="comment">//有记录，需要更新</span></span><br><span class="line">            userLikeDetail.setStatus(item.getStatus());</span><br><span class="line">            userLikeDetail.setUpdateTime(LocalDateTime.now());</span><br><span class="line">            userLikeDetailMapper.updateById(item);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">transLikedCountFromRedis2DB</span><span class="params">()</span> &#123;</span><br><span class="line">    List&lt;UserLikCountDTO&gt; list = redisService.getLikedCountFromRedis();</span><br><span class="line">    list.stream().forEach(item-&gt;&#123;</span><br><span class="line">        <span class="type">UserLikeCount</span> <span class="variable">user</span> <span class="operator">=</span> userLikeCountMapper.selectById(item.getKey());</span><br><span class="line">        <span class="comment">//点赞数量属于无关紧要的操作，出错无需抛异常</span></span><br><span class="line">        <span class="keyword">if</span> (user != <span class="literal">null</span>)&#123;</span><br><span class="line">            <span class="type">Integer</span> <span class="variable">likeNum</span> <span class="operator">=</span> user.getLikeNum() + item.getValue();</span><br><span class="line">            user.setLikeNum(likeNum);</span><br><span class="line">            <span class="comment">//更新点赞数量</span></span><br><span class="line">            userLikeCountMapper.updateById(user);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
                
            </div>
        </article>
    
        <article class="post article-entry">
            <div class="post-title">
                <a class="post-title-link text-underline" href="/2022/08/27/385/">Redis实现限流</a>
            </div>
            <p class="sub">Aug 27 2022</p>
            <div class="post-content">
                
                    <h3 id="1、引入依赖"><a href="#1、引入依赖" class="headerlink" title="1、引入依赖"></a>1、引入依赖</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">  &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">  &lt;artifactId&gt;spring-boot-starter-data-redis&lt;/artifactId&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br><span class="line"></span><br><span class="line">&lt;!-- redis依赖commons-pool 这个依赖一定要添加 --&gt;</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">  &lt;groupId&gt;org.apache.commons&lt;/groupId&gt;</span><br><span class="line">  &lt;artifactId&gt;commons-pool2&lt;/artifactId&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure>
<h3 id="2、application-yml配置"><a href="#2、application-yml配置" class="headerlink" title="2、application.yml配置"></a>2、application.yml配置</h3><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line"><span class="attr">port:</span> <span class="number">8181</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="attr">redis:</span></span><br><span class="line">  <span class="attr">host:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">6379</span></span><br><span class="line">  <span class="attr">timeout:</span> <span class="string">10s</span></span><br><span class="line">  <span class="attr">lettuce:</span></span><br><span class="line">    <span class="attr">pool:</span></span><br><span class="line">    <span class="comment"># 连接池中的最小空闲连接 默认0</span></span><br><span class="line">      <span class="attr">min-idle:</span> <span class="number">0</span></span><br><span class="line">      <span class="comment"># 连接池中的最大空闲连接 默认8</span></span><br><span class="line">      <span class="attr">max-idle:</span> <span class="number">8</span></span><br><span class="line">      <span class="comment"># 连接池最大连接数 默认8 ，负数表示没有限制</span></span><br><span class="line">      <span class="attr">max-active:</span> <span class="number">8</span></span><br><span class="line">      <span class="comment"># 连接池最大阻塞等待时间（使用负值表示没有限制） 默认-1</span></span><br><span class="line">      <span class="attr">max-wait:</span> <span class="string">-1ms</span></span><br><span class="line">  <span class="comment">#选择哪个库存储，默认是0</span></span><br><span class="line">  <span class="attr">database:</span> <span class="number">0</span></span><br><span class="line">  <span class="attr">password:</span> <span class="number">123456</span></span><br></pre></td></tr></table></figure>
<h3 id="3、创建redisConfig，引入redisTemplate"><a href="#3、创建redisConfig，引入redisTemplate" class="headerlink" title="3、创建redisConfig，引入redisTemplate"></a>3、创建redisConfig，引入redisTemplate</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RedisConfig</span> &#123;</span><br><span class="line">   <span class="meta">@Bean</span></span><br><span class="line">   <span class="keyword">public</span> RedisTemplate&lt;String, Object&gt; <span class="title function_">redisTemplate</span><span class="params">(LettuceConnectionFactory redisConnectionFactory)</span> &#123;</span><br><span class="line">       RedisTemplate&lt;String, Object&gt; redisTemplate = <span class="keyword">new</span> <span class="title class_">RedisTemplate</span>&lt;String, Object&gt;();</span><br><span class="line">       redisTemplate.setKeySerializer(<span class="keyword">new</span> <span class="title class_">StringRedisSerializer</span>());</span><br><span class="line">       redisTemplate.setValueSerializer(<span class="keyword">new</span> <span class="title class_">GenericJackson2JsonRedisSerializer</span>());</span><br><span class="line">       redisTemplate.setHashKeySerializer(<span class="keyword">new</span> <span class="title class_">StringRedisSerializer</span>());</span><br><span class="line">       redisTemplate.setHashValueSerializer(<span class="keyword">new</span> <span class="title class_">GenericJackson2JsonRedisSerializer</span>());</span><br><span class="line">       redisTemplate.setConnectionFactory(redisConnectionFactory);</span><br><span class="line">       <span class="keyword">return</span> redisTemplate;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="4、写自定义注解和拦截器"><a href="#4、写自定义注解和拦截器" class="headerlink" title="4、写自定义注解和拦截器"></a>4、写自定义注解和拦截器</h3><p>1、自定义注解</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="meta">@Target(ElementType.METHOD)</span></span><br><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> AccessLimit &#123;</span><br><span class="line">   <span class="type">int</span> <span class="title function_">seconds</span><span class="params">()</span>; <span class="comment">//秒数</span></span><br><span class="line">   <span class="type">int</span> <span class="title function_">maxCount</span><span class="params">()</span>; <span class="comment">//最大访问次数</span></span><br><span class="line">   <span class="type">boolean</span> <span class="title function_">needLogin</span><span class="params">()</span><span class="keyword">default</span> <span class="literal">true</span>;<span class="comment">//是否需要登录</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>2、创建拦截器</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FangshuaInterceptor</span> <span class="keyword">extends</span> <span class="title class_">HandlerInterceptorAdapter</span> &#123;</span><br><span class="line"></span><br><span class="line">   <span class="meta">@Autowired</span></span><br><span class="line">   <span class="keyword">private</span> RedisTemplate redisTemplate;</span><br><span class="line"></span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line">   <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">preHandle</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">       <span class="comment">//判断请求是否属于方法的请求</span></span><br><span class="line">       <span class="keyword">if</span>(handler <span class="keyword">instanceof</span> HandlerMethod)&#123;</span><br><span class="line">           <span class="type">HandlerMethod</span> <span class="variable">hm</span> <span class="operator">=</span> (HandlerMethod) handler;</span><br><span class="line">           <span class="comment">//获取方法中的注解,看是否有该注解</span></span><br><span class="line">           <span class="type">AccessLimit</span> <span class="variable">accessLimit</span> <span class="operator">=</span> hm.getMethodAnnotation(AccessLimit.class);</span><br><span class="line">           <span class="keyword">if</span>(accessLimit == <span class="literal">null</span>)&#123;</span><br><span class="line">               <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">          &#125;</span><br><span class="line">           <span class="type">int</span> <span class="variable">seconds</span> <span class="operator">=</span> accessLimit.seconds();</span><br><span class="line">           <span class="type">int</span> <span class="variable">maxCount</span> <span class="operator">=</span> accessLimit.maxCount();</span><br><span class="line">           <span class="type">boolean</span> <span class="variable">login</span> <span class="operator">=</span> accessLimit.needLogin();</span><br><span class="line">           <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> request.getRequestURI();</span><br><span class="line">           <span class="comment">//如果需要登录</span></span><br><span class="line">           <span class="keyword">if</span>(login)&#123;</span><br><span class="line">               <span class="comment">//获取登录的session进行判断，此处只是例子，不写具体的业务</span></span><br><span class="line">               <span class="comment">//.....</span></span><br><span class="line">               key+=<span class="string">&quot;&quot;</span>+<span class="string">&quot;1&quot;</span>;  <span class="comment">//这里假设用户是1,项目中是动态获取的userId</span></span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">           <span class="comment">//从redis中获取用户访问的次数</span></span><br><span class="line">           Integer count;</span><br><span class="line">           <span class="keyword">if</span>(Objects.isNull(redisTemplate.opsForValue().get(key)))&#123;</span><br><span class="line">               count = <span class="number">0</span>;</span><br><span class="line">          &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">               count = (Integer) redisTemplate.opsForValue().get(key);</span><br><span class="line">          &#125;</span><br><span class="line">           <span class="keyword">if</span>(count == <span class="number">0</span>)&#123;</span><br><span class="line">               redisTemplate.opsForValue().set(key,<span class="number">1</span>,seconds, TimeUnit.SECONDS);</span><br><span class="line">          &#125;<span class="keyword">else</span> <span class="keyword">if</span>(count&lt;maxCount)&#123;</span><br><span class="line">               <span class="comment">//key的值加1</span></span><br><span class="line">               redisTemplate.opsForValue().increment(key);</span><br><span class="line">          &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">               <span class="comment">//超出访问次数</span></span><br><span class="line">               Map&lt;String,Object&gt; errMap=<span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">               errMap.put(<span class="string">&quot;code&quot;</span>,<span class="number">400</span>);</span><br><span class="line">               errMap.put(<span class="string">&quot;msg&quot;</span>,<span class="string">&quot;请求超时，请稍后再试&quot;</span>);</span><br><span class="line">               render(response,errMap); <span class="comment">//这里的CodeMsg是一个返回参数</span></span><br><span class="line">               <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br><span class="line">       <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">render</span><span class="params">(HttpServletResponse response, Map&lt;String,Object&gt; errMap)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">       response.setContentType(<span class="string">&quot;application/json;charset=UTF-8&quot;</span>);</span><br><span class="line">       <span class="type">OutputStream</span> <span class="variable">out</span> <span class="operator">=</span> response.getOutputStream();</span><br><span class="line">       <span class="type">String</span> <span class="variable">str</span> <span class="operator">=</span> JSON.toJSONString(errMap);</span><br><span class="line">       out.write(str.getBytes(<span class="string">&quot;UTF-8&quot;</span>));</span><br><span class="line">       out.flush();</span><br><span class="line">       out.close();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>3、将自定义拦截器加入到拦截器列表中</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WebConfig</span> <span class="keyword">extends</span> <span class="title class_">WebMvcConfigurerAdapter</span> &#123;</span><br><span class="line"></span><br><span class="line">   <span class="meta">@Autowired</span></span><br><span class="line">   <span class="keyword">private</span> FangshuaInterceptor interceptor;</span><br><span class="line"></span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addInterceptors</span><span class="params">(InterceptorRegistry registry)</span> &#123;</span><br><span class="line">       registry.addInterceptor(interceptor);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>4、测试</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;test&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestController</span> &#123;</span><br><span class="line"></span><br><span class="line">   <span class="comment">//每三十秒最多可以请求三次，不需要登录</span></span><br><span class="line">   <span class="meta">@AccessLimit(seconds=30, maxCount=3, needLogin=false)</span></span><br><span class="line">   <span class="meta">@PostMapping(&quot;/fangshua&quot;)</span></span><br><span class="line">   <span class="keyword">public</span> String <span class="title function_">fangshua</span><span class="params">()</span>&#123;</span><br><span class="line">       <span class="keyword">return</span> <span class="string">&quot;成功&quot;</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
                
            </div>
        </article>
    
        <article class="post article-entry">
            <div class="post-title">
                <a class="post-title-link text-underline" href="/2022/07/15/384/">JWT实战</a>
            </div>
            <p class="sub">Jul 15 2022</p>
            <div class="post-content">
                
                    <h3 id="一、在pom文件中引入jwt的依赖包"><a href="#一、在pom文件中引入jwt的依赖包" class="headerlink" title="一、在pom文件中引入jwt的依赖包"></a>一、在pom文件中引入jwt的依赖包</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">&lt;groupId&gt;com.auth0&lt;/groupId&gt;</span><br><span class="line">&lt;artifactId&gt;java-jwt&lt;/artifactId&gt;</span><br><span class="line">&lt;version&gt;3.7.0&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure>
<h3 id="二、写一个工具类用于生成签名和验证签名"><a href="#二、写一个工具类用于生成签名和验证签名" class="headerlink" title="二、写一个工具类用于生成签名和验证签名"></a>二、写一个工具类用于生成签名和验证签名</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JwtUtil</span> &#123;</span><br><span class="line"></span><br><span class="line">   <span class="comment">//JWT-account</span></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">ACCOUNT</span> <span class="operator">=</span> <span class="string">&quot;username&quot;</span>;</span><br><span class="line">   <span class="comment">//JWT-currentTimeMillis</span></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="type">String</span> <span class="variable">CURRENT_TIME_MILLIS</span> <span class="operator">=</span> <span class="string">&quot;currentTimeMillis&quot;</span>;</span><br><span class="line">   <span class="comment">//有效期时间2小时</span></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">EXPIRE_TIME</span> <span class="operator">=</span> <span class="number">2</span> * <span class="number">60</span> * <span class="number">60</span> * <span class="number">1000L</span>;</span><br><span class="line">   <span class="comment">//秘钥</span></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">SECRET_KEY</span> <span class="operator">=</span> <span class="string">&quot;shirokey&quot;</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 生成签名返回token</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> account</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> currentTimeMillis</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">sign</span><span class="params">(String account, String currentTimeMillis)</span> &#123;</span><br><span class="line">       <span class="comment">// 帐号加JWT私钥加密</span></span><br><span class="line">       <span class="type">String</span> <span class="variable">secret</span> <span class="operator">=</span> account + SECRET_KEY;</span><br><span class="line">       <span class="comment">// 此处过期时间，单位：毫秒，在当前时间到后边的20分钟内都是有效的</span></span><br><span class="line">       <span class="type">Date</span> <span class="variable">date</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Date</span>(System.currentTimeMillis() + EXPIRE_TIME);</span><br><span class="line">       <span class="comment">//采用HMAC256加密</span></span><br><span class="line">       <span class="type">Algorithm</span> <span class="variable">algorithm</span> <span class="operator">=</span> Algorithm.HMAC256(secret);</span><br><span class="line"></span><br><span class="line">       <span class="keyword">return</span> JWT.create()</span><br><span class="line">              .withClaim(ACCOUNT, account)</span><br><span class="line">              .withClaim(CURRENT_TIME_MILLIS, currentTimeMillis)</span><br><span class="line">              .withExpiresAt(date)</span><br><span class="line">               <span class="comment">//创建一个新的JWT，并使用给定的算法进行标记</span></span><br><span class="line">              .sign(algorithm);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 校验token是否正确</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> token</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">verify</span><span class="params">(String token)</span> &#123;</span><br><span class="line">       <span class="type">String</span> <span class="variable">secret</span> <span class="operator">=</span> getClaim(token, ACCOUNT) + SECRET_KEY;</span><br><span class="line">       <span class="type">Algorithm</span> <span class="variable">algorithm</span> <span class="operator">=</span> Algorithm.HMAC256(secret);</span><br><span class="line">       <span class="type">JWTVerifier</span> <span class="variable">verifier</span> <span class="operator">=</span> JWT.require(algorithm)</span><br><span class="line">              .build();</span><br><span class="line">       verifier.verify(token);</span><br><span class="line">       <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 获得Token中的信息无需secret解密也能获得</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> token</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> claim</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">getClaim</span><span class="params">(String token, String claim)</span> &#123;</span><br><span class="line">       <span class="keyword">try</span> &#123;</span><br><span class="line">           <span class="type">DecodedJWT</span> <span class="variable">jwt</span> <span class="operator">=</span> JWT.decode(token);</span><br><span class="line">           <span class="keyword">return</span> jwt.getClaim(claim).asString();</span><br><span class="line">      &#125; <span class="keyword">catch</span> (JWTDecodeException e) &#123;</span><br><span class="line">           <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="三、封装自己的token，用于后边校验token类型"><a href="#三、封装自己的token，用于后边校验token类型" class="headerlink" title="三、封装自己的token，用于后边校验token类型"></a>三、封装自己的token，用于后边校验token类型</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JwtToken</span> <span class="keyword">implements</span> <span class="title class_">AuthenticationToken</span> &#123;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">final</span> String token;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">public</span> <span class="title function_">JwtToken</span><span class="params">(String token)</span>&#123;</span><br><span class="line">       <span class="built_in">this</span>.token = token;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line">   <span class="keyword">public</span> Object <span class="title function_">getPrincipal</span><span class="params">()</span> &#123;</span><br><span class="line">       <span class="keyword">return</span> token;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line">   <span class="keyword">public</span> Object <span class="title function_">getCredentials</span><span class="params">()</span> &#123;</span><br><span class="line">       <span class="keyword">return</span> token;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<h3 id="四、我们需要在登陆时创建token"><a href="#四、我们需要在登陆时创建token" class="headerlink" title="四、我们需要在登陆时创建token"></a>四、我们需要在登陆时创建token</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//service中的登录处理</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> UserTokenDTO <span class="title function_">login</span><span class="params">(UserTokenDTO userInfo)</span> &#123;</span><br><span class="line">   <span class="comment">// 从数据库获取对应用户名密码的用户</span></span><br><span class="line">   <span class="type">SysUserInfo</span> <span class="variable">uInfo</span> <span class="operator">=</span> userInfoMapper.getUserByLogin(userInfo.getName());</span><br><span class="line">   <span class="keyword">if</span> (<span class="literal">null</span> == uInfo) &#123;</span><br><span class="line">       <span class="comment">//用户信息不存在</span></span><br><span class="line">       <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BusinessException</span>(CommonResultStatus.USERNAME_ERROR);</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!userInfo.getPassword().equals(uInfo.getPassword())) &#123;</span><br><span class="line">       <span class="comment">//密码错误</span></span><br><span class="line">       <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BusinessException</span>(CommonResultStatus.PASSWORD_ERROR);</span><br><span class="line">  &#125;</span><br><span class="line">   <span class="comment">//生成jwtToken</span></span><br><span class="line">   userInfo.setToken(JwtUtil.sign(userInfo.getName(),String.valueOf(System.currentTimeMillis())));</span><br><span class="line">   <span class="keyword">return</span> userInfo;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="五、在其他需要登录后才能访问的请求中解析token，所以我们要自定义过滤器"><a href="#五、在其他需要登录后才能访问的请求中解析token，所以我们要自定义过滤器" class="headerlink" title="五、在其他需要登录后才能访问的请求中解析token，所以我们要自定义过滤器"></a>五、在其他需要登录后才能访问的请求中解析token，所以我们要自定义过滤器</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JwtFilter</span> <span class="keyword">extends</span> <span class="title class_">AccessControlFilter</span> &#123;</span><br><span class="line"></span><br><span class="line">   <span class="comment">//设置请求头中需要传递的字段名</span></span><br><span class="line">   <span class="keyword">protected</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">AUTHORIZATION_HEADER</span> <span class="operator">=</span> <span class="string">&quot;Access-Token&quot;</span>;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 表示是否允许访问，mappedValue就是[urls]配置中拦截器参数部分，</span></span><br><span class="line"><span class="comment">    * 如果允许访问返回true，否则false</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@author</span> cheetah</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@date</span> 2020/11/24</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> request:</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> response:</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> mappedValue:</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span>: boolean</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line">   <span class="keyword">protected</span> <span class="type">boolean</span> <span class="title function_">isAccessAllowed</span><span class="params">(ServletRequest request, ServletResponse response, Object mappedValue)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">       <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 表示当访问拒绝时是否已经处理了，</span></span><br><span class="line"><span class="comment">    * 如果返回true表示需要继续处理，</span></span><br><span class="line"><span class="comment">    * 如果返回false表示该拦截器实例已经处理了，将直接返回即可</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@author</span> cheetah</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@date</span> 2020/11/24</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> request:</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> response:</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span>: boolean</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line">   <span class="keyword">protected</span> <span class="type">boolean</span> <span class="title function_">onAccessDenied</span><span class="params">(ServletRequest request, ServletResponse response)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">       <span class="type">HttpServletRequest</span> <span class="variable">req</span> <span class="operator">=</span> (HttpServletRequest) request;</span><br><span class="line">       <span class="comment">// 解决跨域问题</span></span><br><span class="line">       <span class="keyword">if</span>(HttpMethod.OPTIONS.toString().matches(req.getMethod())) &#123;</span><br><span class="line">           <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">      &#125;</span><br><span class="line">       <span class="keyword">if</span> (isLoginAttempt(request, response)) &#123;</span><br><span class="line">           <span class="comment">//生成jwt token</span></span><br><span class="line">           <span class="type">JwtToken</span> <span class="variable">token</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JwtToken</span>(req.getHeader(AUTHORIZATION_HEADER));</span><br><span class="line">           <span class="comment">//委托给Realm进行验证</span></span><br><span class="line">           <span class="keyword">try</span> &#123;</span><br><span class="line">               <span class="comment">//调用登陆会走Realm中的身份验证方法</span></span><br><span class="line">               getSubject(request, response).login(token);</span><br><span class="line">               <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">          &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BusinessException</span>(CommonResultStatus.LOGIN_ERROR);</span><br><span class="line">      &#125;</span><br><span class="line">       </span><br><span class="line">       <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 判断是否有头部参数</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@author</span> cheetah</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@date</span> 2020/11/24</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> request:</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> response:</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span>: boolean</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="keyword">protected</span> <span class="type">boolean</span> <span class="title function_">isLoginAttempt</span><span class="params">(ServletRequest request, ServletResponse response)</span> &#123;</span><br><span class="line">       <span class="type">HttpServletRequest</span> <span class="variable">req</span> <span class="operator">=</span> (HttpServletRequest) request;</span><br><span class="line">       <span class="type">String</span> <span class="variable">authorization</span> <span class="operator">=</span> req.getHeader(AUTHORIZATION_HEADER);</span><br><span class="line">       <span class="keyword">return</span> authorization != <span class="literal">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="六、当滤器中调用subject-login-token-方法时，会走自定义Realm中的doGetAuthenticationInfo-AuthenticationToken-token-方法来验证身份"><a href="#六、当滤器中调用subject-login-token-方法时，会走自定义Realm中的doGetAuthenticationInfo-AuthenticationToken-token-方法来验证身份" class="headerlink" title="六、当滤器中调用subject.login(token)方法时，会走自定义Realm中的doGetAuthenticationInfo(AuthenticationToken token)方法来验证身份"></a>六、当滤器中调用subject.login(token)方法时，会走自定义Realm中的doGetAuthenticationInfo(AuthenticationToken token)方法来验证身份</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JwtRealm</span> <span class="keyword">extends</span> <span class="title class_">AuthorizingRealm</span> &#123;</span><br><span class="line"></span><br><span class="line">   <span class="meta">@Autowired</span></span><br><span class="line">   <span class="keyword">private</span> UserInfoService userService;</span><br><span class="line"></span><br><span class="line">   <span class="comment">//验证是不是自己的token类型</span></span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line">   <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">supports</span><span class="params">(AuthenticationToken token)</span> &#123;</span><br><span class="line">       <span class="keyword">return</span> token <span class="keyword">instanceof</span> JwtToken;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 身份验证</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@author</span> cheetah</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@date</span> 2020/11/25</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> token:</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span>: org.apache.shiro.authc.AuthenticationInfo</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line">   <span class="keyword">protected</span> AuthenticationInfo <span class="title function_">doGetAuthenticationInfo</span><span class="params">(AuthenticationToken token)</span> <span class="keyword">throws</span> AuthenticationException &#123;</span><br><span class="line">       <span class="type">String</span> <span class="variable">credentials</span> <span class="operator">=</span> (String) token.getCredentials();</span><br><span class="line">       <span class="type">String</span> <span class="variable">username</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">       <span class="keyword">try</span> &#123;</span><br><span class="line">           <span class="comment">//jwt验证token</span></span><br><span class="line">           <span class="type">boolean</span> <span class="variable">verify</span> <span class="operator">=</span> JwtUtil.verify(credentials);</span><br><span class="line">           <span class="keyword">if</span> (!verify) &#123;</span><br><span class="line">               <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">AuthenticationException</span>(<span class="string">&quot;Token校验不正确&quot;</span>);</span><br><span class="line">          &#125;</span><br><span class="line">           username = JwtUtil.getClaim(credentials, JwtUtil.ACCOUNT);</span><br><span class="line">      &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BusinessException</span>(CommonResultStatus.TOKEN_CHECK_ERROR,e.getMessage());</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">       <span class="comment">//交给AuthenticatingRealm使用CredentialsMatcher进行密码匹配，不设置则使用默认的SimpleCredentialsMatcher</span></span><br><span class="line">       <span class="type">SimpleAuthenticationInfo</span> <span class="variable">authenticationInfo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SimpleAuthenticationInfo</span>(</span><br><span class="line">               username, <span class="comment">//用户名</span></span><br><span class="line">               credentials, <span class="comment">//凭证</span></span><br><span class="line">               getName()  <span class="comment">//realm name</span></span><br><span class="line">      );</span><br><span class="line">       <span class="keyword">return</span> authenticationInfo;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 权限校验（次数不做过多讲解）</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@author</span> cheetah</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@date</span> 2020/11/25</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> principals:</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span>: org.apache.shiro.authz.AuthorizationInfo</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line">   <span class="keyword">protected</span> AuthorizationInfo <span class="title function_">doGetAuthorizationInfo</span><span class="params">(PrincipalCollection principals)</span> &#123;</span><br><span class="line"><span class="comment">//       String username = principals.toString();</span></span><br><span class="line">       <span class="type">SimpleAuthorizationInfo</span> <span class="variable">authorizationInfo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SimpleAuthorizationInfo</span>();</span><br><span class="line">       <span class="comment">//角色权限暂时不加</span></span><br><span class="line"><span class="comment">//       authorizationInfo.setRoles(userService.getRoles(username));</span></span><br><span class="line"><span class="comment">//       authorizationInfo.setStringPermissions(userService.queryPermissions(username));</span></span><br><span class="line">       <span class="keyword">return</span> authorizationInfo;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="七、接下来我们需要修改ShiroConfig文件，将自定义的Filter和Realm交由SecurityManager进行管理"><a href="#七、接下来我们需要修改ShiroConfig文件，将自定义的Filter和Realm交由SecurityManager进行管理" class="headerlink" title="七、接下来我们需要修改ShiroConfig文件，将自定义的Filter和Realm交由SecurityManager进行管理"></a>七、接下来我们需要修改ShiroConfig文件，将自定义的Filter和Realm交由SecurityManager进行管理</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">此类较长，只展示部分重要代码，其余代码可在公众号“阿Q说”中回复&quot;jwt&quot;获取源码</span></span><br><span class="line"><span class="comment">**/</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ShiroConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 创建ShiroFilterFactoryBean</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@author</span> cheetah</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@date</span> 2020/11/21</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span>: org.apache.shiro.spring.web.ShiroFilterFactoryBean</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="meta">@Bean</span></span><br><span class="line">   <span class="keyword">public</span> ShiroFilterFactoryBean <span class="title function_">shiroFilter</span><span class="params">(SecurityManager securityManager)</span>&#123;</span><br><span class="line">       <span class="type">ShiroFilterFactoryBean</span> <span class="variable">shiroFilterFactoryBean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ShiroFilterFactoryBean</span>();</span><br><span class="line">       <span class="comment">// 必须设置 SecurityManager</span></span><br><span class="line">       shiroFilterFactoryBean.setSecurityManager(securityManager);</span><br><span class="line">       <span class="comment">//设置shiro内置过滤器</span></span><br><span class="line">       Map&lt;String, Filter&gt; filters = <span class="keyword">new</span> <span class="title class_">LinkedHashMap</span>&lt;&gt;();</span><br><span class="line">       <span class="comment">//添加自定义过滤器：只对需要登陆的接口进行过滤</span></span><br><span class="line">       filters.put(<span class="string">&quot;authc&quot;</span>, <span class="keyword">new</span> <span class="title class_">JwtFilter</span>());</span><br><span class="line">       <span class="comment">//添加自定义过滤器：对权限进行验证</span></span><br><span class="line"><span class="comment">//       filters.put(&quot;roles&quot;, new CustomRolesOrAuthorizationFilter());</span></span><br><span class="line">       shiroFilterFactoryBean.setFilters(filters);</span><br><span class="line"></span><br><span class="line">       <span class="comment">// setLoginUrl 如果不设置值，默认会自动寻找Web工程根目录下的&quot;/login.jsp&quot;页面 或 &quot;/login&quot; 映射</span></span><br><span class="line">       shiroFilterFactoryBean.setLoginUrl(<span class="string">&quot;/adminLogin/login&quot;</span>);</span><br><span class="line">       <span class="comment">// 设置无权限时跳转的 url;</span></span><br><span class="line">       shiroFilterFactoryBean.setUnauthorizedUrl(<span class="string">&quot;/notAuth&quot;</span>);</span><br><span class="line"></span><br><span class="line">       <span class="comment">// 设置拦截器</span></span><br><span class="line">       Map&lt;String, String&gt; filterChainDefinitionMap = <span class="keyword">new</span> <span class="title class_">LinkedHashMap</span>&lt;&gt;();</span><br><span class="line">       <span class="comment">//游客，开发权限</span></span><br><span class="line">       filterChainDefinitionMap.put(<span class="string">&quot;/guest/**&quot;</span>, <span class="string">&quot;anon&quot;</span>);</span><br><span class="line">       <span class="comment">//用户，需要角色权限 “user”</span></span><br><span class="line">       filterChainDefinitionMap.put(<span class="string">&quot;/user/**&quot;</span>, <span class="string">&quot;roles[user]&quot;</span>);</span><br><span class="line"><span class="comment">//       filterChainDefinitionMap.put(&quot;/productInfo/**&quot;, &quot;roles[user]&quot;);</span></span><br><span class="line">       <span class="comment">//管理员，需要角色权限 “admin”</span></span><br><span class="line">       filterChainDefinitionMap.put(<span class="string">&quot;/admin/**&quot;</span>, <span class="string">&quot;roles[admin]&quot;</span>);</span><br><span class="line">       <span class="comment">//开放登陆接口</span></span><br><span class="line">       filterChainDefinitionMap.put(<span class="string">&quot;/adminLogin/login&quot;</span>, <span class="string">&quot;anon&quot;</span>);</span><br><span class="line">       <span class="comment">//其余接口一律拦截</span></span><br><span class="line">       <span class="comment">//主要这行代码必须放在所有权限设置的最后，不然会导致所有 url 都被拦截</span></span><br><span class="line">       filterChainDefinitionMap.put(<span class="string">&quot;/**&quot;</span>, <span class="string">&quot;authc&quot;</span>);</span><br><span class="line"></span><br><span class="line">       shiroFilterFactoryBean.setFilterChainDefinitionMap(filterChainDefinitionMap);</span><br><span class="line">       log.info(<span class="string">&quot;-------Shiro拦截器工厂类注入成功-----------&quot;</span>);</span><br><span class="line">       <span class="keyword">return</span> shiroFilterFactoryBean;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 注入安全管理器</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@author</span> cheetah</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@date</span> 2020/11/21</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span>: java.lang.SecurityManager</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="meta">@Bean</span></span><br><span class="line">   <span class="keyword">public</span> DefaultWebSecurityManager <span class="title function_">securityManager</span><span class="params">(JwtRealm jwtRealm, SubjectFactory subjectFactory,</span></span><br><span class="line"><span class="params">                                                    SessionManager sessionManager,</span></span><br><span class="line"><span class="params">                                                    CacheManager cacheManager)</span> &#123;</span><br><span class="line">       <span class="type">DefaultWebSecurityManager</span> <span class="variable">securityManager</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultWebSecurityManager</span>();</span><br><span class="line">       securityManager.setRealm(jwtRealm);</span><br><span class="line"></span><br><span class="line">       <span class="comment">//关闭shiro自带的session</span></span><br><span class="line">       <span class="type">DefaultSubjectDAO</span> <span class="variable">subjectDAO</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultSubjectDAO</span>();</span><br><span class="line">       <span class="type">DefaultSessionStorageEvaluator</span> <span class="variable">defaultSessionStorageEvaluator</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultSessionStorageEvaluator</span>();</span><br><span class="line">       defaultSessionStorageEvaluator.setSessionStorageEnabled(<span class="literal">false</span>);</span><br><span class="line">       subjectDAO.setSessionStorageEvaluator(defaultSessionStorageEvaluator);</span><br><span class="line">       securityManager.setSubjectDAO(subjectDAO);</span><br><span class="line">       securityManager.setSubjectFactory(subjectFactory);</span><br><span class="line">       securityManager.setSessionManager(sessionManager);</span><br><span class="line">       securityManager.setCacheManager(cacheManager);</span><br><span class="line">       <span class="keyword">return</span> securityManager;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * jwt身份认证和权限校验</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@author</span> cheetah</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@date</span> 2020/11/24</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span>: com.cheetah.shiroandjwt.jwt.JwtRealm</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="meta">@Bean</span></span><br><span class="line">   <span class="keyword">public</span> JwtRealm <span class="title function_">jwtRealm</span><span class="params">()</span> &#123;</span><br><span class="line">       <span class="type">JwtRealm</span> <span class="variable">jwtRealm</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JwtRealm</span>();</span><br><span class="line">       jwtRealm.setAuthenticationCachingEnabled(<span class="literal">true</span>);</span><br><span class="line">       jwtRealm.setAuthorizationCachingEnabled(<span class="literal">true</span>);</span><br><span class="line">       <span class="keyword">return</span> jwtRealm;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
                
            </div>
        </article>
    
        <article class="post article-entry">
            <div class="post-title">
                <a class="post-title-link text-underline" href="/2022/04/15/383/">Shiro简介</a>
            </div>
            <p class="sub">Apr 15 2022</p>
            <div class="post-content">
                
                    <h3 id="Shiro简介"><a href="#Shiro简介" class="headerlink" title="Shiro简介"></a>Shiro简介</h3><p>Apache Shiro是一个强大且易用的Java安全框架，执行身份验证、授权、密码和会话管理。目前，使用 Apache Shiro 的人越来越多，因为它相当简单，对比 Spring Security，可能没有 Spring Security 做的功能强大，但是在实际工作时可能并不需要那么复杂的东西，所以使用小而简单的 Shiro 就足够了。shiro由三大组件构成：<code>Subject、SecurityManager、Realm</code>。<br><code>Subject</code>：可以理解为主体或者用户，是一个抽象概念，这个用户不一定是一个具体的人，可以是与当前应用交互的任何东西。</p>
<p><code>SecurityManager</code>：安全管理器，即所有与安全有关的操作都会与 SecurityManager 交互；是 Shiro 的核心，它管理着所有 Subject，且负责进行认证和授权、会话、缓存的管理。</p>
<p><code>Realm</code>：域，Shiro 从 Realm 获取安全数据（如用户、角色、权限），就是说 SecurityManager 要验证用户身份，那么它需要从 Realm 获取相应的用户进行比较以确定用户身份是否合法；也需要从 Realm 得到用户相应的角色 &#x2F; 权限进行验证用户是否能进行操作；可以把 Realm 看成 DataSource，即安全数据源。</p>
<p>总结一下，就是最简单的一个 Shiro 应用：</p>
<p>应用代码通过 Subject 来进行认证和授权，而 Subject 又委托给 SecurityManager；</p>
<p>我们需要给 Shiro 的 SecurityManager 注入 Realm，从而让 SecurityManager 能得到合法的用户及其权限进行判断。</p>
<p>接下来就让我们在代码层面继承一下shiro。首先我们要准备好环境，创建一个简单的springboot工程，配置及数据库操作这里不再赘述，有需要的可以后台私聊阿Q呦。</p>
<h3 id="集成Shiro"><a href="#集成Shiro" class="headerlink" title="集成Shiro"></a>集成Shiro</h3><p>一、引入shiro的依赖包</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">   &lt;groupId&gt;org.apache.shiro&lt;/groupId&gt;</span><br><span class="line">   &lt;artifactId&gt;shiro-spring&lt;/artifactId&gt;</span><br><span class="line">   &lt;version&gt;1.5.3&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure>
<p>二、自定义Realm进行权限认证和身份认证</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CustomRealm</span> <span class="keyword">extends</span> <span class="title class_">AuthorizingRealm</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">   <span class="keyword">private</span> SysUserInfoMapper userInfoMapper;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 权限认证/获取授权信息</span></span><br><span class="line"><span class="comment">    * 该方法只有在需要权限认证时才会进入，</span></span><br><span class="line"><span class="comment">    * 比如前面配置类中配置了</span></span><br><span class="line"><span class="comment">    * filterChainDefinitionMap.put(&quot;/admin/**&quot;, &quot;roles[admin]&quot;); 的管理员角色，</span></span><br><span class="line"><span class="comment">    * 这时进入 /admin 时就会进入该方法来检查权限</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@author</span> cheetah</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@date</span> 2020/11/21</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> principals:</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span>: org.apache.shiro.authz.AuthorizationInfo</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line">   <span class="keyword">protected</span> AuthorizationInfo <span class="title function_">doGetAuthorizationInfo</span><span class="params">(PrincipalCollection principals)</span> &#123;</span><br><span class="line">       log.info(<span class="string">&quot;————权限认证————&quot;</span>);</span><br><span class="line">       <span class="type">String</span> <span class="variable">username</span> <span class="operator">=</span> (String) SecurityUtils.getSubject().getPrincipal();</span><br><span class="line">       <span class="type">SimpleAuthorizationInfo</span> <span class="variable">info</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SimpleAuthorizationInfo</span>();</span><br><span class="line">       <span class="comment">//获得该用户角色</span></span><br><span class="line">       <span class="type">String</span> <span class="variable">role</span> <span class="operator">=</span> userInfoMapper.getRole(username);</span><br><span class="line">       Set&lt;String&gt; set = <span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;&gt;();</span><br><span class="line">       <span class="comment">//需要将 role 封装到 Set 作为 info.setRoles() 的参数</span></span><br><span class="line">       set.add(role);</span><br><span class="line">       <span class="comment">//设置该用户拥有的角色</span></span><br><span class="line">       info.setRoles(set);</span><br><span class="line">       <span class="keyword">return</span> info;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 身份认证/获取身份验证信息</span></span><br><span class="line"><span class="comment">    * Shiro中，最终是通过 Realm 来获取应用程序中的用户、角色及权限信息的。</span></span><br><span class="line"><span class="comment">    * 该方法则是需要身份认证时（比如前面的 Subject.login() 方法）才会进入</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@author</span> cheetah</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@date</span> 2020/11/21</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> authenticationToken: 用户身份信息 token</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span>: org.apache.shiro.authc.AuthenticationInfo</span></span><br><span class="line"><span class="comment">    * 返回封装了用户信息的 AuthenticationInfo 实例</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line">   <span class="keyword">protected</span> AuthenticationInfo <span class="title function_">doGetAuthenticationInfo</span><span class="params">(AuthenticationToken authenticationToken)</span> <span class="keyword">throws</span> AuthenticationException &#123;</span><br><span class="line">       log.info(<span class="string">&quot;————身份认证方法————&quot;</span>);</span><br><span class="line">       <span class="type">UsernamePasswordToken</span> <span class="variable">token</span> <span class="operator">=</span> (UsernamePasswordToken) authenticationToken;</span><br><span class="line">       <span class="comment">// 从数据库获取对应用户名密码的用户</span></span><br><span class="line">       <span class="type">SysUserInfo</span> <span class="variable">userInfo</span> <span class="operator">=</span> userInfoMapper.getUserByLogin(token.getUsername());</span><br><span class="line">       <span class="keyword">if</span> (<span class="literal">null</span> == userInfo) &#123;</span><br><span class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BusinessException</span>(CommonResultStatus.USERNAME_ERROR);</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!userInfo.getPassword().equals(<span class="keyword">new</span> <span class="title class_">String</span>((<span class="type">char</span>[]) token.getCredentials()))) &#123;</span><br><span class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BusinessException</span>(CommonResultStatus.PASSWORD_ERROR);</span><br><span class="line">      &#125;</span><br><span class="line">       <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">SimpleAuthenticationInfo</span>(token.getPrincipal(), userInfo.getPassword(), getName());</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>三、创建ShiroConfig，将ShiroFilterFactoryBean交由spring管理；将自定义的身份认证交由SecurityManager管理</p>
<p>代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ShiroConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 创建ShiroFilterFactoryBean</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@author</span> cheetah</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@date</span> 2020/11/21</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span>: org.apache.shiro.spring.web.ShiroFilterFactoryBean</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="meta">@Bean</span></span><br><span class="line">   <span class="keyword">public</span> ShiroFilterFactoryBean <span class="title function_">shiroFilter</span><span class="params">()</span>&#123;</span><br><span class="line">       <span class="type">ShiroFilterFactoryBean</span> <span class="variable">shiroFilterFactoryBean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ShiroFilterFactoryBean</span>();</span><br><span class="line">       <span class="comment">// 必须设置 SecurityManager</span></span><br><span class="line">       shiroFilterFactoryBean.setSecurityManager(securityManager());</span><br><span class="line">       <span class="comment">//设置shiro内置过滤器</span></span><br><span class="line">       Map&lt;String, Filter&gt; filters = <span class="keyword">new</span> <span class="title class_">LinkedHashMap</span>&lt;&gt;();</span><br><span class="line">       <span class="comment">//增加自定义过滤器，只对需要登陆的接口进行过滤</span></span><br><span class="line">       filters.put(<span class="string">&quot;authc&quot;</span>, <span class="keyword">new</span> <span class="title class_">CustomRolesOrAuthorizationFilter</span>());</span><br><span class="line">       <span class="comment">//filters.put(&quot;roles&quot;, new CustomRolesOrAuthorizationFilter());</span></span><br><span class="line">       shiroFilterFactoryBean.setFilters(filters);</span><br><span class="line"></span><br><span class="line">       <span class="comment">// setLoginUrl 如果不设置值，默认会自动寻找Web工程根目录下的&quot;/login.jsp&quot;页面 或 &quot;/login&quot; 映射</span></span><br><span class="line">       shiroFilterFactoryBean.setLoginUrl(<span class="string">&quot;/adminLogin/login&quot;</span>);</span><br><span class="line">       <span class="comment">// 设置无权限时跳转的 url;</span></span><br><span class="line">       shiroFilterFactoryBean.setUnauthorizedUrl(<span class="string">&quot;/notAuth&quot;</span>);</span><br><span class="line"></span><br><span class="line">       <span class="comment">// 设置拦截器</span></span><br><span class="line">       Map&lt;String, String&gt; filterChainDefinitionMap = <span class="keyword">new</span> <span class="title class_">LinkedHashMap</span>&lt;&gt;();</span><br><span class="line">       <span class="comment">//游客，开发权限</span></span><br><span class="line">       filterChainDefinitionMap.put(<span class="string">&quot;/guest/**&quot;</span>, <span class="string">&quot;anon&quot;</span>);</span><br><span class="line">       <span class="comment">//用户，需要角色权限 “user”</span></span><br><span class="line">       filterChainDefinitionMap.put(<span class="string">&quot;/user/**&quot;</span>, <span class="string">&quot;roles[user]&quot;</span>);</span><br><span class="line">       <span class="comment">//管理员，需要角色权限 “admin”</span></span><br><span class="line">       filterChainDefinitionMap.put(<span class="string">&quot;/admin/**&quot;</span>, <span class="string">&quot;roles[admin]&quot;</span>);</span><br><span class="line">       <span class="comment">//商品，需要角色权限 “user”</span></span><br><span class="line">       <span class="comment">//filterChainDefinitionMap.put(&quot;/productInfo/**&quot;, &quot;roles[user]&quot;);</span></span><br><span class="line">       <span class="comment">//开放登陆接口</span></span><br><span class="line">       filterChainDefinitionMap.put(<span class="string">&quot;/adminLogin/login&quot;</span>, <span class="string">&quot;anon&quot;</span>);</span><br><span class="line">       <span class="comment">//其余接口一律拦截</span></span><br><span class="line">       <span class="comment">//主要这行代码必须放在所有权限设置的最后，不然会导致所有 url 都被拦截</span></span><br><span class="line">       filterChainDefinitionMap.put(<span class="string">&quot;/**&quot;</span>, <span class="string">&quot;authc&quot;</span>);</span><br><span class="line"></span><br><span class="line">       shiroFilterFactoryBean.setFilterChainDefinitionMap(filterChainDefinitionMap);</span><br><span class="line">       log.info(<span class="string">&quot;-------Shiro拦截器工厂类注入成功-----------&quot;</span>);</span><br><span class="line">       <span class="keyword">return</span> shiroFilterFactoryBean;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 注入安全管理器</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@author</span> cheetah</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@date</span> 2020/11/21</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span>: java.lang.SecurityManager</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="meta">@Bean</span></span><br><span class="line">   <span class="keyword">public</span> SecurityManager <span class="title function_">securityManager</span><span class="params">()</span>&#123;</span><br><span class="line">       <span class="type">DefaultWebSecurityManager</span> <span class="variable">securityManager</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultWebSecurityManager</span>();</span><br><span class="line">       <span class="comment">// 设置realm.</span></span><br><span class="line">       securityManager.setRealm(customRealm());</span><br><span class="line">       <span class="keyword">return</span> securityManager;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 注入自定义身份认证</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@author</span> cheetah</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@date</span> 2020/11/21</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span>: com.cheetah.shiroandjwt.config.CustomRealm</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="meta">@Bean</span></span><br><span class="line">   <span class="keyword">public</span> CustomRealm <span class="title function_">customRealm</span><span class="params">()</span>&#123;</span><br><span class="line">       <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">CustomRealm</span>();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>补充：</p>
<p>anon：无需认证（登陆）可以访问</p>
<p>authc：必须认证才可以访问</p>
<p>user：如果使用rememberMe的功能可以直接访问</p>
<p>perms：该资源必须得到资源权限才可以访问</p>
<p>role：该资源必须得到角色权限才可以访问</p>
<p>四、自定义的过滤器代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CustomRolesOrAuthorizationFilter</span> <span class="keyword">extends</span> <span class="title class_">AuthorizationFilter</span>&#123;</span><br><span class="line"></span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line">   <span class="keyword">protected</span> <span class="type">boolean</span> <span class="title function_">isAccessAllowed</span><span class="params">(ServletRequest request, ServletResponse response, Object mappedValue)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">       <span class="comment">//验证用户是否登陆，若是未登陆直接返回异常信息</span></span><br><span class="line">       <span class="type">Subject</span> <span class="variable">subject</span> <span class="operator">=</span> getSubject(request, response);</span><br><span class="line">       <span class="type">Object</span> <span class="variable">principal</span> <span class="operator">=</span> subject.getPrincipal();</span><br><span class="line">       <span class="keyword">if</span>(principal==<span class="literal">null</span>)&#123;</span><br><span class="line">           <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">      &#125;</span><br><span class="line">       <span class="comment">//获取当前访问路径所需要的角色集合</span></span><br><span class="line">       String[] rolesArray = (String[]) mappedValue;</span><br><span class="line">       <span class="comment">//没有角色限制，可以直接访问</span></span><br><span class="line">       <span class="keyword">if</span> (rolesArray == <span class="literal">null</span> || rolesArray.length == <span class="number">0</span>) &#123;</span><br><span class="line">           <span class="comment">//没有指定角色的话不需要进行验证，放行</span></span><br><span class="line">           <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">       Set&lt;String&gt; roles = CollectionUtils.asSet(rolesArray);</span><br><span class="line">       <span class="comment">//当前subject是roles中的任意一个，则有权限访问</span></span><br><span class="line">       <span class="keyword">for</span>(String role : roles)&#123;</span><br><span class="line">           <span class="keyword">if</span>(subject.hasRole(role))&#123;</span><br><span class="line">               <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br><span class="line">       <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>五、接下来根据业务来测试一下shiro的相关功能，附上业务测试代码：登陆代码+商品列表代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;adminLogin&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LoginController</span> &#123;</span><br><span class="line"></span><br><span class="line">   <span class="meta">@Autowired</span></span><br><span class="line">   <span class="keyword">private</span> UserInfoService userInfoService;</span><br><span class="line"></span><br><span class="line">   <span class="meta">@PostMapping(&quot;login&quot;)</span></span><br><span class="line">   <span class="keyword">public</span> AjaxResult <span class="title function_">login</span><span class="params">(<span class="meta">@RequestBody</span> SysUserInfo userInfo)</span>&#123;</span><br><span class="line">       <span class="type">Subject</span> <span class="variable">subject</span> <span class="operator">=</span> SecurityUtils.getSubject();</span><br><span class="line">       <span class="type">UsernamePasswordToken</span> <span class="variable">token</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UsernamePasswordToken</span>(userInfo.getName(),userInfo.getPassword());</span><br><span class="line">       subject.login(token);</span><br><span class="line">       <span class="keyword">return</span> AjaxResult.success(<span class="string">&quot;登陆成功&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/productInfo&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ProductInfoController</span> &#123;</span><br><span class="line"></span><br><span class="line">   <span class="meta">@Autowired</span></span><br><span class="line">   <span class="keyword">private</span> ProductInfoService productInfoService;</span><br><span class="line"></span><br><span class="line">   <span class="meta">@RequestMapping(&quot;/getProductList&quot;)</span></span><br><span class="line">   <span class="keyword">public</span> AjaxResult <span class="title function_">getProductList</span><span class="params">()</span>&#123;</span><br><span class="line">       List&lt;ProductInfo&gt; list = productInfoService.getProductInfoList();</span><br><span class="line">       <span class="keyword">return</span> AjaxResult.success(list);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="疑问："><a href="#疑问：" class="headerlink" title="疑问："></a>疑问：</h3><p>成功登录之后，再次请求时，服务器是如何知道已经登录，是哪个用户，是使用HttpSession还是shiro的Session的呢？</p>
<p>在处理请求时，ShiroFilterFactoryBean实现了FactoryBean接口，在加载ShiroFilterFactoryBean时实际会加载SpringShiroFilter并添加到应用的过滤器链中。当有请求进来的时候，都会被SpringShiroFilter拦截到。Subject值就是在SpringShiroFilter拦截的过程中设置到线程变量中的。SpringShiroFilter的拦截方法中最关键的两步是createSubject和bind到ThreadContext里。到这里，可以理出大致的流程，用户发起请求-&gt;调用SpringShiroFilter的doFilter-&gt;创建Subject-&gt;设置到线程变量中，方便在后面取出使用。</p>
<p>创建subject可以分为以下三步：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">将request、response封装成shiro的ShiroHttpServletRequest，ShiroHttpServletResponse</span><br><span class="line"></span><br><span class="line">获取session、principals的值设置到context里</span><br><span class="line"></span><br><span class="line">根据context生成Subject</span><br></pre></td></tr></table></figure>
<h3 id="重点：ShiroConfig中ShiroFilterFactoryBean的讲解："><a href="#重点：ShiroConfig中ShiroFilterFactoryBean的讲解：" class="headerlink" title="重点：ShiroConfig中ShiroFilterFactoryBean的讲解："></a>重点：ShiroConfig中ShiroFilterFactoryBean的讲解：</h3><p>当代码中有filterChainDefinitionMap.put(“&#x2F;productInfo&#x2F;**”, “roles[user]”);时，代表商品列表需要权限验证，此时不会去走自定义的过滤器；</p>
<p>而当将代码中的 filters.put(“authc”, new CustomRolesOrAuthorizationFilter());</p>
<p>改为filters.put(“roles”, new CustomRolesOrAuthorizationFilter()); 时，代码会先去走该过滤器进行权限验证，isAccessAllowed(ServletRequest request, ServletResponse response, Object mappedValue)中的mappedValue便是roles[user]中括号里的集合。</p>
<p>  想了解更多学习知识，请关注微信公众号“阿Q说”，回复“shiro”可获取本期源码！你也可以后台留言说出你的疑惑，阿Q将会在后期的文章中为你解答。每天学习一点点，每天进步一点点。</p>

                
            </div>
        </article>
    
        <article class="post article-entry">
            <div class="post-title">
                <a class="post-title-link text-underline" href="/2022/01/15/382/">Redis使用场景</a>
            </div>
            <p class="sub">Jan 15 2022</p>
            <div class="post-content">
                
                    <h3 id="1、缓存"><a href="#1、缓存" class="headerlink" title="1、缓存"></a>1、缓存</h3><p>String类型<br>例如：热点数据缓存（例如报表、明星出轨），对象缓存、全页缓存、可以提升热点数据的访问数据。</p>
<h3 id="2、数据共享分布式"><a href="#2、数据共享分布式" class="headerlink" title="2、数据共享分布式"></a>2、数据共享分布式</h3><p>String 类型，因为 Redis 是分布式的独立服务，可以在多个应用之间共享<br>例如：分布式Session</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt; </span><br><span class="line">&lt;groupId&gt;org.springframework.session&lt;/groupId&gt; </span><br><span class="line">&lt;artifactId&gt;spring-session-data-redis&lt;/artifactId&gt; </span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure>
<h3 id="3、分布式锁"><a href="#3、分布式锁" class="headerlink" title="3、分布式锁"></a>3、分布式锁</h3><p>String 类型setnx方法，只有不存在时才能添加成功，返回true</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">getLock</span><span class="params">(String key)</span> &#123;</span><br><span class="line">    <span class="type">Long</span> <span class="variable">flag</span> <span class="operator">=</span> jedis.setnx(key, <span class="string">&quot;1&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (flag == <span class="number">1</span>) &#123;</span><br><span class="line">        jedis.expire(key, <span class="number">10</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> flag == <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">releaseLock</span><span class="params">(String key)</span> &#123;</span><br><span class="line">    jedis.del(key);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="4、全局ID"><a href="#4、全局ID" class="headerlink" title="4、全局ID"></a>4、全局ID</h3><p>int类型，incrby，利用原子性<br>incrby userid 1000<br>分库分表的场景，一次性拿一段</p>
<h3 id="5、计数器"><a href="#5、计数器" class="headerlink" title="5、计数器"></a>5、计数器</h3><p>int类型，incr方法<br>例如：文章的阅读量、微博点赞数、允许一定的延迟，先写入Redis再定时同步到数据库</p>
<h3 id="6、限流"><a href="#6、限流" class="headerlink" title="6、限流"></a>6、限流</h3><p>int类型，incr方法<br>以访问者的ip和其他信息作为key，访问一次增加一次计数，超过次数则返回false</p>
<h3 id="7、位统计"><a href="#7、位统计" class="headerlink" title="7、位统计"></a>7、位统计</h3><p>String类型的bitcount（1.6.6的bitmap数据结构介绍）<br>字符是以8位二进制存储的</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">set k1 a</span><br><span class="line">setbit k1 6 1</span><br><span class="line">setbit k1 7 0</span><br><span class="line">get k1 </span><br><span class="line">/* 6 7 代表的a的二进制位的修改</span><br><span class="line">a 对应的ASCII码是97，转换为二进制数据是01100001</span><br><span class="line">b 对应的ASCII码是98，转换为二进制数据是01100010</span><br></pre></td></tr></table></figure>
<p>因为bit非常节省空间（1 MB&#x3D;8388608 bit），可以用来做大数据量的统计。<br>例如：在线用户统计，留存用户统计</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">setbit onlineusers 01 </span><br><span class="line">setbit onlineusers 11 </span><br><span class="line">setbit onlineusers 20</span><br></pre></td></tr></table></figure>
<p>支持按位与、按位或等等操作<br>BITOPANDdestkeykey[key…] ，对一个或多个 key 求逻辑并，并将结果保存到 destkey 。<br>BITOPORdestkeykey[key…] ，对一个或多个 key 求逻辑或，并将结果保存到 destkey 。<br>BITOPXORdestkeykey[key…] ，对一个或多个 key 求逻辑异或，并将结果保存到 destkey 。<br>BITOPNOTdestkeykey ，对给定 key 求逻辑非，并将结果保存到 destkey 。<br>计算出7天都在线的用户<br>BITOP “AND” “7_days_both_online_users” “day_1_online_users” “day_2_online_users” …  “day_7_online_users”</p>
<h3 id="8、购物车"><a href="#8、购物车" class="headerlink" title="8、购物车"></a>8、购物车</h3><p>String 或hash。所有String可以做的hash都可以做<br>HSET key field value [field value …]<br>key：用户id；field：商品id；value：商品数量。<br>+1：hincr。-1：hdecr。删除：hdel。全选：hgetall。商品数：hlen。</p>
<h3 id="9、用户消息时间线"><a href="#9、用户消息时间线" class="headerlink" title="9、用户消息时间线"></a>9、用户消息时间线</h3><p>list，双向链表，直接作为timeline就好了。插入有序</p>
<h3 id="10、消息队列"><a href="#10、消息队列" class="headerlink" title="10、消息队列"></a>10、消息队列</h3><p>List提供了两个阻塞的弹出操作：blpop&#x2F;brpop，可以设置超时时间<br>blpop：blpop key1 timeout 移除并获取列表的第一个元素，如果列表没有元素会阻塞列表直到等待超时或发现可弹出元素为止。<br>brpop：brpop key1 timeout 移除并获取列表的最后一个元素，如果列表没有元素会阻塞列表直到等待超时或发现可弹出元素为止。<br>上面的操作。其实就是java的阻塞队列。学习的东西越多。学习成本越低<br>队列：先进先除：rpush blpop，左头右尾，右边进入队列，左边出队列<br>栈：先进后出：rpush brpop</p>
<h3 id="11、抽奖"><a href="#11、抽奖" class="headerlink" title="11、抽奖"></a>11、抽奖</h3><p>自带一个随机获得值<br>spop myset</p>
<h3 id="12、点赞、签到、打卡"><a href="#12、点赞、签到、打卡" class="headerlink" title="12、点赞、签到、打卡"></a>12、点赞、签到、打卡</h3><p>假如上面的微博ID是t1001，用户ID是u3001<br>用 like:t1001 来维护 t1001 这条微博的所有点赞用户<br>点赞了这条微博：sadd like:t1001 u3001<br>取消点赞：srem like:t1001 u3001<br>是否点赞：sismember like:t1001 u3001<br>点赞的所有用户：smembers like:t1001<br>点赞数：scard like:t1001<br>​ 是不是比数据库简单多了。哈哈</p>
<h3 id="13、商品标签"><a href="#13、商品标签" class="headerlink" title="13、商品标签"></a>13、商品标签</h3><p>老规矩，用 tags:i5001 来维护商品所有的标签。<br>sadd tags:i5001 画面清晰细腻<br>sadd tags:i5001 真彩清晰显示屏<br>sadd tags:i5001 流程至极</p>
<h3 id="14、商品筛选"><a href="#14、商品筛选" class="headerlink" title="14、商品筛选"></a>14、商品筛选</h3><p>获取差集<br>sdiff set1 set2<br>获取交集（intersection ）<br>sinter set1 set2<br>获取并集<br>sunion set1 set2<br>假如：iPhone11 上市了<br>sadd brand:apple iPhone11<br>sadd brand:ios iPhone11<br>sad screensize:6.0-6.24 iPhone11<br>sad screentype:lcd iPhone 11<br>赛选商品，苹果的、ios的、屏幕在6.0-6.24之间的，屏幕材质是LCD屏幕<br>sinter brand:apple brand:ios screensize:6.0-6.24 screentype:lcd</p>
<h3 id="15、用户关注、推荐模型"><a href="#15、用户关注、推荐模型" class="headerlink" title="15、用户关注、推荐模型"></a>15、用户关注、推荐模型</h3><p>follow 关注 fans 粉丝</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">相互关注：</span><br><span class="line">        sadd 1:follow 2</span><br><span class="line">        sadd 2:fans 1</span><br><span class="line">        sadd 1:fans 2</span><br><span class="line">        sadd 2:follow 1</span><br></pre></td></tr></table></figure>
<p>我关注的人也关注了他(取交集)：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">        sinter 1:follow 2:fans</span><br></pre></td></tr></table></figure>
<p>可能认识的人：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">        用户1可能认识的人(差集)：sdiff 2:follow 1:follow</span><br><span class="line">        用户2可能认识的人：sdiff 1:follow 2:follow</span><br></pre></td></tr></table></figure>
<h3 id="16、排行榜"><a href="#16、排行榜" class="headerlink" title="16、排行榜"></a>16、排行榜</h3><p>id 为6001 的新闻点击数加1</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">zincrby hotNews:20190926 1 n6001</span><br></pre></td></tr></table></figure>
<p>获取今天点击最多的15条：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">zrevrange hotNews:20190926 0 15 withscores</span><br></pre></td></tr></table></figure>
                
            </div>
        </article>
    
        <article class="post article-entry">
            <div class="post-title">
                <a class="post-title-link text-underline" href="/2021/04/15/381/">https过程</a>
            </div>
            <p class="sub">Apr 15 2021</p>
            <div class="post-content">
                
                    <ol>
<li>客户端向服务器发起HTTPS请求，连接到服务器的443端口</li>
<li>服务器端有一个密钥对，即公钥和私钥，是用来进行非对称加密使用的，服务器端保存着私钥，不能将其泄露，公钥可以发送给任何人。</li>
<li>服务器将自己的公钥发送给客户端。</li>
<li>客户端收到服务器端的证书之后，会对证书进行检查，验证其合法性，如果发现发现证书有问题，那么HTTPS传输就无法继续。<br>严格的说，这里应该是验证服务器发送的数字证书的合法性，关于客户端如何验证数字证书的合法性，下文会进行说明。<br>如果公钥合格，那么客户端会生成一个随机值，这个随机值就是用于进行对称加密的密钥，我们将该密钥称之为client key，即客户端密钥，这样在概念上和服务器端的密钥容易进行区分。<br>然后用服务器的公钥对客户端密钥进行非对称加密，这样客户端密钥就变成密文了，至此，HTTPS中的第一次HTTP请求结束。</li>
<li>客户端会发起HTTPS中的第二个HTTP请求，将加密之后的客户端密钥发送给服务器。</li>
<li>服务器接收到客户端发来的密文之后，会用自己的私钥对其进行非对称解密，解密之后的明文就是客户端密钥，然后用客户端密钥对数据进行对称加密，这样数据就变成了密文。</li>
<li>然后服务器将加密后的密文发送给客户端。</li>
<li>客户端收到服务器发送来的密文，用客户端密钥对其进行对称解密，得到服务器发送的数据。这样HTTPS中的第二个HTTP请求结束，整个HTTPS传输完成。</li>
</ol>

                
            </div>
        </article>
    
</div>
<div class="side-bar">


    <div class="avator" id="avator">
    <div class="title">
        <a href="#" class="text-underline">About Me</a>
    </div>
        <img src="avator.jpg" class="ava-img">
        <h3 class="author">shang wj</h3>
        <div class="icon-list">
        <a href="yourweibo"><i class="iconfont icon-weibo icon-item"></i></a>
        <a href="mailto:youremail"><i class="iconfont icon-email icon-item"></i></a>
        <a href="yourgithub"><i class="iconfont icon-github icon-item"></i></a>
        <a href="yourlinkedin"><i class="iconfont icon-linkedin icon-item"></i></a>
        </div>
    <div class="tags">
    <h3 class="tags-title">Tags</h3>
    <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%BF%83%E6%83%85/" rel="tag">心情</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%9F%A5%E8%AF%86%E7%82%B9/" rel="tag">知识点</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/enable/" rel="tag">enable</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/systemctl/" rel="tag">systemctl</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%BC%80%E6%9C%BA/" rel="tag">开机</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/php-fpm/" rel="tag">php-fpm</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/php/" rel="tag">php</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%95%B0%E6%8D%AE%E5%BA%93/" rel="tag">数据库</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/obj/" rel="tag">obj</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/str/" rel="tag">str</a><span class="tag-list-count">1</span></li></ul>
</div>
    </div>
</div>

</section>

    <nav class="page-nav">
    
        <a class="prev" href="/page/2/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text">Prev</span>
        </a>
    
    
        <a class="next" href="/page/4/">
            <span class="next-text">Next</span>
            <i class="iconfont icon-right"></i>
        </a>
    
    </nav>



            </main>
            <div class="copyright">
  <div class="text">Powered By
    <a target="_blank" rel="noopener" href="https://hexo.io/">Hexo</a> | Theme <a target="_blank" rel="noopener" href="https://github.com/zjx137/hexo-theme-Tsu">Tsu</a> &copy 2019
  </div>
</div>

        </div>
    <div class="back-to-top" id="back-to-top">
            <i class="iconfont icon-up"></i>
    </div>
        
    </body>
    
<script src="/js/jquery-3.3.1.min.js"></script>

    
<script src="/js/back-to-top.js"></script>

    
<script src="/js/scroll.js"></script>

    <!-- MathJax配置，可通过单美元符号书写行内公式等 -->
<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
    "HTML-CSS": { 
        preferredFont: "TeX", 
        availableFonts: ["STIX","TeX"], 
        linebreaks: { automatic:true }, 
        EqnChunk: (MathJax.Hub.Browser.isMobile ? 10 : 50) 
    },
    tex2jax: { 
        inlineMath: [ ["$", "$"], ["\\(","\\)"] ], 
        processEscapes: true, 
        ignoreClass: "tex2jax_ignore|dno",
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    },
    TeX: {  
        equationNumbers: { autoNumber: "AMS" },
        noUndefined: { attributes: { mathcolor: "red", mathbackground: "#FFEEEE", mathsize: "90%" } }, 
        Macros: { href: "{}" } 
    },
    messageStyle: "none"
    }); 
</script>
<!-- 给MathJax元素添加has-jax class -->
<script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for(i=0; i < all.length; i += 1) {
            all[i].SourceElement().parentNode.className += ' has-jax';
        }
    });
</script>
<!-- 通过连接CDN加载MathJax的js代码 -->
<script type="text/javascript" async
  src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-MML-AM_CHTML">
</script>

</html>
